/*! IndexedDBShim - v0.1.2 - 2013-06-22 */
var idbModules={};(function(e){function t(e,t,n,o){n.target=t,"function"==typeof t[e]&&t[e].apply(t,[n]),"function"==typeof o&&o()}function n(t,n,o){var i=new DOMException.constructor(0,n);throw i.name=t,i.message=n,i.stack=arguments.callee.caller,e.DEBUG&&console.log(t,n,o,i),i}var o=function(){this.length=0,this._items=[],Object.defineProperty&&Object.defineProperty(this,"_items",{enumerable:!1})};if(o.prototype={contains:function(e){return-1!==this._items.indexOf(e)},item:function(e){return this._items[e]},indexOf:function(e){return this._items.indexOf(e)},push:function(e){this._items.push(e),this.length+=1;for(var t=0;this._items.length>t;t++)this[t]=this._items[t]},splice:function(){this._items.splice.apply(this._items,arguments),this.length=this._items.length;for(var e in this)e===parseInt(e,10)+""&&delete this[e];for(e=0;this._items.length>e;e++)this[e]=this._items[e]}},Object.defineProperty)for(var i in{indexOf:!1,push:!1,splice:!1})Object.defineProperty(o.prototype,i,{enumerable:!1});e.util={throwDOMException:n,callback:t,quote:function(e){return"'"+e+"'"},StringList:o}})(idbModules),function(e){var t=function(){return{encode:function(e){return JSON.stringify(e)},decode:function(e){return JSON.parse(e)}}}();e.Sca=t}(idbModules),function(e){var t=["","number","string","boolean","object","undefined"],n=function(){return{encode:function(e){return t.indexOf(typeof e)+"-"+JSON.stringify(e)},decode:function(e){return e===void 0?void 0:JSON.parse(e.substring(2))}}},o={number:n("number"),"boolean":n(),object:n(),string:{encode:function(e){return t.indexOf("string")+"-"+e},decode:function(e){return""+e.substring(2)}},undefined:{encode:function(){return t.indexOf("undefined")+"-undefined"},decode:function(){return void 0}}},i=function(){return{encode:function(e){return o[typeof e].encode(e)},decode:function(e){return o[t[e.substring(0,1)]].decode(e)}}}();e.Key=i}(idbModules),function(e){var t=function(e,t){return{type:e,debug:t,bubbles:!1,cancelable:!1,eventPhase:0,timeStamp:new Date}};e.Event=t}(idbModules),function(e){var t=function(){this.onsuccess=this.onerror=this.result=this.error=this.source=this.transaction=null,this.readyState="pending"},n=function(){this.onblocked=this.onupgradeneeded=null};n.prototype=t,e.IDBRequest=t,e.IDBOpenRequest=n}(idbModules),function(e,t){var n=function(e,t,n,o){this.lower=e,this.upper=t,this.lowerOpen=n,this.upperOpen=o};n.only=function(e){return new n(e,e,!0,!0)},n.lowerBound=function(e,o){return new n(e,t,o,t)},n.upperBound=function(e){return new n(t,e,t,open)},n.bound=function(e,t,o,i){return new n(e,t,o,i)},e.IDBKeyRange=n}(idbModules),function(e,t){function n(n,o,i,r,s,a){this.__range=n,this.source=this.__idbObjectStore=i,this.__req=r,this.key=t,this.direction=o,this.__keyColumnName=s,this.__valueColumnName=a,this.source.transaction.__active||e.util.throwDOMException("TransactionInactiveError - The transaction this IDBObjectStore belongs to is not active."),this.__offset=-1,this.__lastKeyContinued=t,this["continue"]()}n.prototype.__find=function(n,o,i,r){var s=this,a=["SELECT * FROM ",e.util.quote(s.__idbObjectStore.name)],u=[];a.push("WHERE ",s.__keyColumnName," NOT NULL"),s.__range&&(s.__range.lower||s.__range.upper)&&(a.push("AND"),s.__range.lower&&(a.push(s.__keyColumnName+(s.__range.lowerOpen?" >":" >= ")+" ?"),u.push(e.Key.encode(s.__range.lower))),s.__range.lower&&s.__range.upper&&a.push("AND"),s.__range.upper&&(a.push(s.__keyColumnName+(s.__range.upperOpen?" < ":" <= ")+" ?"),u.push(e.Key.encode(s.__range.upper)))),n!==t&&(s.__lastKeyContinued=n,s.__offset=0),s.__lastKeyContinued!==t&&(a.push("AND "+s.__keyColumnName+" >= ?"),u.push(e.Key.encode(s.__lastKeyContinued))),a.push("ORDER BY ",s.__keyColumnName),a.push("LIMIT 1 OFFSET "+s.__offset),e.DEBUG&&console.log(a.join(" "),u),o.executeSql(a.join(" "),u,function(n,o){if(1===o.rows.length){var r=e.Key.decode(o.rows.item(0)[s.__keyColumnName]),a="value"===s.__valueColumnName?e.Sca.decode(o.rows.item(0)[s.__valueColumnName]):e.Key.decode(o.rows.item(0)[s.__valueColumnName]);i(r,a)}else e.DEBUG&&console.log("Reached end of cursors"),i(t,t)},function(t,n){e.DEBUG&&console.log("Could not execute Cursor.continue"),r(n)})},n.prototype["continue"]=function(e){var n=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(o,i,r,s){n.__offset++,n.__find(e,o,function(e,o){n.key=e,n.value=o,r(n.key!==t?n:t,n.__req)},function(e){s(e)})})},n.prototype.advance=function(n){0>=n&&e.util.throwDOMException("Type Error - Count is invalid - 0 or negative",n);var o=this;this.__idbObjectStore.transaction.__addToTransactionQueue(function(e,i,r,s){o.__offset+=n,o.__find(t,e,function(e,n){o.key=e,o.value=n,r(o.key!==t?o:t,o.__req)},function(e){s(e)})})},n.prototype.update=function(n){var o=this;return this.__idbObjectStore.transaction.__addToTransactionQueue(function(i,r,s,a){o.__find(t,i,function(t){var r="UPDATE "+e.util.quote(o.__idbObjectStore.name)+" SET value = ? WHERE key = ?";e.DEBUG&&console.log(r,n,t),i.executeSql(r,[e.Sca.encode(n),e.Key.encode(t)],function(e,n){1===n.rowsAffected?s(t):a("No rowns with key found"+t)},function(e,t){a(t)})},function(e){a(e)})})},n.prototype["delete"]=function(){var n=this;return this.__idbObjectStore.transaction.__addToTransactionQueue(function(o,i,r,s){n.__find(t,o,function(i){var a="DELETE FROM  "+e.util.quote(n.__idbObjectStore.name)+" WHERE key = ?";e.DEBUG&&console.log(a,i),o.executeSql(a,[e.Key.encode(i)],function(e,n){1===n.rowsAffected?r(t):s("No rowns with key found"+i)},function(e,t){s(t)})},function(e){s(e)})})},e.IDBCursor=n}(idbModules),function(idbModules,undefined){function IDBIndex(e,t){this.indexName=this.name=e,this.__idbObjectStore=this.objectStore=this.source=t;var n=t.__storeProps&&t.__storeProps.indexList;n&&(n=JSON.parse(n)),this.keyPath=n&&n[e]&&n[e].keyPath||e,["multiEntry","unique"].forEach(function(t){this[t]=!!(n&&n[e]&&n[e].optionalParams&&n[e].optionalParams[t])},this)}IDBIndex.prototype.__createIndex=function(indexName,keyPath,optionalParameters){var me=this,transaction=me.__idbObjectStore.transaction;transaction.__addToTransactionQueue(function(tx,args,success,failure){me.__idbObjectStore.__getStoreProps(tx,function(){function error(){idbModules.util.throwDOMException(0,"Could not create new index",arguments)}2!==transaction.mode&&idbModules.util.throwDOMException(0,"Invalid State error, not a version transaction",me.transaction);var idxList=JSON.parse(me.__idbObjectStore.__storeProps.indexList);idxList[indexName]!==undefined&&idbModules.util.throwDOMException(0,"Index already exists on store",idxList);var columnName=indexName;idxList[indexName]={columnName:columnName,keyPath:keyPath,optionalParams:optionalParameters},me.__idbObjectStore.__storeProps.indexList=JSON.stringify(idxList);var sql=["ALTER TABLE",idbModules.util.quote(me.__idbObjectStore.name),"ADD",columnName,"BLOB"].join(" ");idbModules.DEBUG&&console.log(sql),tx.executeSql(sql,[],function(tx,data){tx.executeSql("SELECT * FROM "+idbModules.util.quote(me.__idbObjectStore.name),[],function(tx,data){(function initIndexForRow(i){if(data.rows.length>i)try{var value=idbModules.Sca.decode(data.rows.item(i).value),indexKey=eval("value['"+keyPath+"']");tx.executeSql("UPDATE "+idbModules.util.quote(me.__idbObjectStore.name)+" set "+columnName+" = ? where key = ?",[idbModules.Key.encode(indexKey),data.rows.item(i).key],function(){initIndexForRow(i+1)},error)}catch(e){initIndexForRow(i+1)}else idbModules.DEBUG&&console.log("Updating the indexes in table",me.__idbObjectStore.__storeProps),tx.executeSql("UPDATE __sys__ set indexList = ? where name = ?",[me.__idbObjectStore.__storeProps.indexList,me.__idbObjectStore.name],function(){me.__idbObjectStore.__setReadyState("createIndex",!0),success(me)},error)})(0)},error)},error)},"createObjectStore")})},IDBIndex.prototype.openCursor=function(e,t){var n=new idbModules.IDBRequest;return new idbModules.IDBCursor(e,t,this.source,n,this.indexName,"value"),n},IDBIndex.prototype.openKeyCursor=function(e,t){var n=new idbModules.IDBRequest;return new idbModules.IDBCursor(e,t,this.source,n,this.indexName,"key"),n},IDBIndex.prototype.__fetchIndexData=function(e,t){var n=this;return n.__idbObjectStore.transaction.__addToTransactionQueue(function(o,i,r,s){var a=["SELECT * FROM ",idbModules.util.quote(n.__idbObjectStore.name)," WHERE",n.indexName,"NOT NULL"],u=[];e!==undefined&&(a.push("AND",n.indexName," = ?"),u.push(idbModules.Key.encode(e))),idbModules.DEBUG&&console.log("Trying to fetch data for Index",a.join(" "),u),o.executeSql(a.join(" "),u,function(e,n){var o;o="count"==typeof t?n.rows.length:0===n.rows.length?undefined:"key"===t?idbModules.Key.decode(n.rows.item(0).key):idbModules.Sca.decode(n.rows.item(0).value),r(o)},s)})},IDBIndex.prototype.get=function(e){return this.__fetchIndexData(e,"value")},IDBIndex.prototype.getKey=function(e){return this.__fetchIndexData(e,"key")},IDBIndex.prototype.count=function(e){return this.__fetchIndexData(e,"count")},idbModules.IDBIndex=IDBIndex}(idbModules),function(idbModules){var IDBObjectStore=function(e,t,n){this.name=e,this.transaction=t,this.__ready={},this.__setReadyState("createObjectStore",n===void 0?!0:n),this.indexNames=new idbModules.util.StringList};IDBObjectStore.prototype.__setReadyState=function(e,t){this.__ready[e]=t},IDBObjectStore.prototype.__waitForReady=function(e,t){var n=!0;if(t!==void 0)n=this.__ready[t]===void 0?!0:this.__ready[t];else for(var o in this.__ready)this.__ready[o]||(n=!1);if(n)e();else{idbModules.DEBUG&&console.log("Waiting for to be ready",t);var i=this;window.setTimeout(function(){i.__waitForReady(e,t)},100)}},IDBObjectStore.prototype.__getStoreProps=function(e,t,n){var o=this;this.__waitForReady(function(){o.__storeProps?(idbModules.DEBUG&&console.log("Store properties - cached",o.__storeProps),t(o.__storeProps)):e.executeSql("SELECT * FROM __sys__ where name = ?",[o.name],function(e,n){1!==n.rows.length?t():(o.__storeProps={name:n.rows.item(0).name,indexList:n.rows.item(0).indexList,autoInc:n.rows.item(0).autoInc,keyPath:n.rows.item(0).keyPath},idbModules.DEBUG&&console.log("Store properties",o.__storeProps),t(o.__storeProps))},function(){t()})},n)},IDBObjectStore.prototype.__deriveKey=function(tx,value,key,callback){function getNextAutoIncKey(){tx.executeSql("SELECT * FROM sqlite_sequence where name like ?",[me.name],function(e,t){1!==t.rows.length?callback(0):callback(t.rows.item(0).seq)},function(e,t){idbModules.util.throwDOMException(0,"Data Error - Could not get the auto increment value for key",t)})}var me=this;me.__getStoreProps(tx,function(props){if(props||idbModules.util.throwDOMException(0,"Data Error - Could not locate defination for this table",props),props.keyPath)if(key!==void 0&&idbModules.util.throwDOMException(0,"Data Error - The object store uses in-line keys and the key parameter was provided",props),value)try{var primaryKey=eval("value['"+props.keyPath+"']");primaryKey?callback(primaryKey):"true"===props.autoInc?getNextAutoIncKey():idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath")}catch(e){idbModules.util.throwDOMException(0,"Data Error - Could not eval key from keyPath",e)}else idbModules.util.throwDOMException(0,"Data Error - KeyPath was specified, but value was not");else key!==void 0?callback(key):"false"===props.autoInc?idbModules.util.throwDOMException(0,"Data Error - The object store uses out-of-line keys and has no key generator and the key parameter was not provided. ",props):getNextAutoIncKey()})},IDBObjectStore.prototype.__insertData=function(tx,value,primaryKey,success,error){var paramMap={};primaryKey!==void 0&&(paramMap.key=idbModules.Key.encode(primaryKey));var indexes=JSON.parse(this.__storeProps.indexList);for(var key in indexes)try{paramMap[indexes[key].columnName]=idbModules.Key.encode(eval("value['"+indexes[key].keyPath+"']"))}catch(e){error(e)}var sqlStart=["INSERT INTO ",idbModules.util.quote(this.name),"("],sqlEnd=[" VALUES ("],sqlValues=[];for(key in paramMap)sqlStart.push(key+","),sqlEnd.push("?,"),sqlValues.push(paramMap[key]);sqlStart.push("value )"),sqlEnd.push("?)"),sqlValues.push(idbModules.Sca.encode(value));var sql=sqlStart.join(" ")+sqlEnd.join(" ");idbModules.DEBUG&&console.log("SQL for adding",sql,sqlValues),tx.executeSql(sql,sqlValues,function(){success(primaryKey)},function(e,t){error(t)})},IDBObjectStore.prototype.add=function(e,t){var n=this;return n.transaction.__addToTransactionQueue(function(o,i,r,s){n.__deriveKey(o,e,t,function(t){n.__insertData(o,e,t,r,s)})})},IDBObjectStore.prototype.put=function(e,t){var n=this;return n.transaction.__addToTransactionQueue(function(o,i,r,s){n.__deriveKey(o,e,t,function(t){var i="DELETE FROM "+idbModules.util.quote(n.name)+" where key = ?";o.executeSql(i,[idbModules.Key.encode(t)],function(o,i){idbModules.DEBUG&&console.log("Did the row with the",t,"exist? ",i.rowsAffected),n.__insertData(o,e,t,r,s)},function(e,t){s(t)})})})},IDBObjectStore.prototype.get=function(e){var t=this;return t.transaction.__addToTransactionQueue(function(n,o,i,r){t.__waitForReady(function(){var o=idbModules.Key.encode(e);idbModules.DEBUG&&console.log("Fetching",t.name,o),n.executeSql("SELECT * FROM "+idbModules.util.quote(t.name)+" where key = ?",[o],function(e,t){idbModules.DEBUG&&console.log("Fetched data",t);try{if(0===t.rows.length)return i();i(idbModules.Sca.decode(t.rows.item(0).value))}catch(n){idbModules.DEBUG&&console.log(n),i(void 0)}},function(e,t){r(t)})})})},IDBObjectStore.prototype["delete"]=function(e){var t=this;return t.transaction.__addToTransactionQueue(function(n,o,i,r){t.__waitForReady(function(){var o=idbModules.Key.encode(e);idbModules.DEBUG&&console.log("Fetching",t.name,o),n.executeSql("DELETE FROM "+idbModules.util.quote(t.name)+" where key = ?",[o],function(e,t){idbModules.DEBUG&&console.log("Deleted from database",t.rowsAffected),i()},function(e,t){r(t)})})})},IDBObjectStore.prototype.clear=function(){var e=this;return e.transaction.__addToTransactionQueue(function(t,n,o,i){e.__waitForReady(function(){t.executeSql("DELETE FROM "+idbModules.util.quote(e.name),[],function(e,t){idbModules.DEBUG&&console.log("Cleared all records from database",t.rowsAffected),o()},function(e,t){i(t)})})})},IDBObjectStore.prototype.count=function(e){var t=this;return t.transaction.__addToTransactionQueue(function(n,o,i,r){t.__waitForReady(function(){var o="SELECT * FROM "+idbModules.util.quote(t.name)+(e!==void 0?" WHERE key = ?":""),s=[];e!==void 0&&s.push(idbModules.Key.encode(e)),n.executeSql(o,s,function(e,t){i(t.rows.length)},function(e,t){r(t)})})})},IDBObjectStore.prototype.openCursor=function(e,t){var n=new idbModules.IDBRequest;return new idbModules.IDBCursor(e,t,this,n,"key","value"),n},IDBObjectStore.prototype.index=function(e){var t=new idbModules.IDBIndex(e,this);return t},IDBObjectStore.prototype.createIndex=function(e,t,n){var o=this;n=n||{},o.__setReadyState("createIndex",!1);var i=new idbModules.IDBIndex(e,o);return o.__waitForReady(function(){i.__createIndex(e,t,n)},"createObjectStore"),o.indexNames.push(e),i},IDBObjectStore.prototype.deleteIndex=function(e){var t=new idbModules.IDBIndex(e,this,!1);return t.__deleteIndex(e),t},idbModules.IDBObjectStore=IDBObjectStore}(idbModules),function(e){var t=0,n=1,o=2,i=function(o,i,r){if("number"==typeof i)this.mode=i,2!==i&&e.DEBUG&&console.log("Mode should be a string, but was specified as ",i);else if("string"==typeof i)switch(i){case"readwrite":this.mode=n;break;case"readonly":this.mode=t;break;default:this.mode=t}this.storeNames="string"==typeof o?[o]:o;for(var s=0;this.storeNames.length>s;s++)r.objectStoreNames.contains(this.storeNames[s])||e.util.throwDOMException(0,"The operation failed because the requested database object could not be found. For example, an object store did not exist but was being opened.",this.storeNames[s]);this.__active=!0,this.__running=!1,this.__requests=[],this.__aborted=!1,this.db=r,this.error=null,this.onabort=this.onerror=this.oncomplete=null};i.prototype.__executeRequests=function(){if(this.__running&&this.mode!==o)return e.DEBUG&&console.log("Looks like the request set is already running",this.mode),void 0;this.__running=!0;var t=this;window.setTimeout(function(){2===t.mode||t.__active||e.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",t.__active),t.db.__db.transaction(function(n){function o(t,n){n&&(s.req=n),s.req.readyState="done",s.req.result=t,delete s.req.error;var o=e.Event("success");e.util.callback("onsuccess",s.req,o),a++,r()}function i(){s.req.readyState="done",s.req.error="DOMError";var t=e.Event("error",arguments);e.util.callback("onerror",s.req,t),a++,r()}function r(){return a>=t.__requests.length?(t.__active=!1,t.__requests=[],void 0):(s=t.__requests[a],s.op(n,s.args,o,i),void 0)}t.__tx=n;var s=null,a=0;try{r()}catch(u){e.DEBUG&&console.log("An exception occured in transaction",arguments),"function"==typeof t.onerror&&t.onerror()}},function(){e.DEBUG&&console.log("An error in transaction",arguments),"function"==typeof t.onerror&&t.onerror()},function(){e.DEBUG&&console.log("Transaction completed",arguments),"function"==typeof t.oncomplete&&t.oncomplete()})},1)},i.prototype.__addToTransactionQueue=function(t,n){this.__active||this.mode===o||e.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished.",this.__mode);var i=new e.IDBRequest;return i.source=this.db,this.__requests.push({op:t,args:n,req:i}),this.__executeRequests(),i},i.prototype.objectStore=function(t){return new e.IDBObjectStore(t,this)},i.prototype.abort=function(){!this.__active&&e.util.throwDOMException(0,"A request was placed against a transaction which is currently not active, or which is finished",this.__active)},i.prototype.READ_ONLY=0,i.prototype.READ_WRITE=1,i.prototype.VERSION_CHANGE=2,e.IDBTransaction=i}(idbModules),function(e){var t=function(t,n,o,i){this.__db=t,this.version=o,this.__storeProperties=i,this.objectStoreNames=new e.util.StringList;for(var r=0;i.rows.length>r;r++)this.objectStoreNames.push(i.rows.item(r).name);this.name=n,this.onabort=this.onerror=this.onversionchange=null};t.prototype.createObjectStore=function(t,n){var o=this;n=n||{},n.keyPath=n.keyPath||null;var i=new e.IDBObjectStore(t,o.__versionTransaction,!1),r=o.__versionTransaction;return r.__addToTransactionQueue(function(r,s,a){function u(){e.util.throwDOMException(0,"Could not create new object store",arguments)}o.__versionTransaction||e.util.throwDOMException(0,"Invalid State error",o.transaction);var c=["CREATE TABLE",e.util.quote(t),"(key BLOB",n.autoIncrement?", inc INTEGER PRIMARY KEY AUTOINCREMENT":"PRIMARY KEY",", value BLOB)"].join(" ");e.DEBUG&&console.log(c),r.executeSql(c,[],function(e){e.executeSql("INSERT INTO __sys__ VALUES (?,?,?,?)",[t,n.keyPath,n.autoIncrement?!0:!1,"{}"],function(){i.__setReadyState("createObjectStore",!0),a(i)},u)},u)}),o.objectStoreNames.push(t),i},t.prototype.deleteObjectStore=function(t){var n=function(){e.util.throwDOMException(0,"Could not delete ObjectStore",arguments)},o=this;!o.objectStoreNames.contains(t)&&n("Object Store does not exist"),o.objectStoreNames.splice(o.objectStoreNames.indexOf(t),1);var i=o.__versionTransaction;i.__addToTransactionQueue(function(){o.__versionTransaction||e.util.throwDOMException(0,"Invalid State error",o.transaction),o.__db.transaction(function(o){o.executeSql("SELECT * FROM __sys__ where name = ?",[t],function(o,i){i.rows.length>0&&o.executeSql("DROP TABLE "+e.util.quote(t),[],function(){o.executeSql("DELETE FROM __sys__ WHERE name = ?",[t],function(){},n)},n)})})})},t.prototype.close=function(){},t.prototype.transaction=function(t,n){var o=new e.IDBTransaction(t,n||1,this);return o},e.IDBDatabase=t}(idbModules),function(e){var t=4194304;if(window.openDatabase){var n=window.openDatabase("__sysdb__",1,"System Database",t);n.transaction(function(t){t.executeSql("SELECT * FROM dbVersions",[],function(){},function(){n.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS dbVersions (name VARCHAR(255), version INT);",[],function(){},function(){e.util.throwDOMException("Could not create table __sysdb__ to save DB versions")})})})},function(){e.DEBUG&&console.log("Error in sysdb transaction - when selecting from dbVersions",arguments)});var o={open:function(o,i){function r(){if(!u){var t=e.Event("error",arguments);a.readyState="done",a.error="DOMError",e.util.callback("onerror",a,t),u=!0}}function s(s){var u=window.openDatabase(o,1,o,t);a.readyState="done",i===void 0&&(i=s||1),(0>=i||s>i)&&e.util.throwDOMException(0,"An attempt was made to open a database using a lower version than the existing version.",i),u.transaction(function(t){t.executeSql("CREATE TABLE IF NOT EXISTS __sys__ (name VARCHAR(255), keyPath VARCHAR(255), autoInc BOOLEAN, indexList BLOB)",[],function(){t.executeSql("SELECT * FROM __sys__",[],function(t,c){var d=e.Event("success");a.source=a.result=new e.IDBDatabase(u,o,i,c),i>s?n.transaction(function(t){t.executeSql("UPDATE dbVersions set version = ? where name = ?",[i,o],function(){var t=e.Event("upgradeneeded");t.oldVersion=s,t.newVersion=i,a.transaction=a.result.__versionTransaction=new e.IDBTransaction([],2,a.source),e.util.callback("onupgradeneeded",a,t,function(){var t=e.Event("success");e.util.callback("onsuccess",a,t)})},r)},r):e.util.callback("onsuccess",a,d)},r)},r)},r)}var a=new e.IDBOpenRequest,u=!1;return n.transaction(function(e){e.executeSql("SELECT * FROM dbVersions where name = ?",[o],function(e,t){0===t.rows.length?e.executeSql("INSERT INTO dbVersions VALUES (?,?)",[o,i||1],function(){s(0)},r):s(t.rows.item(0).version)},r)},r),a},deleteDatabase:function(o){function i(t){if(!a){s.readyState="done",s.error="DOMError";var n=e.Event("error");n.message=t,n.debug=arguments,e.util.callback("onerror",s,n),a=!0}}function r(){n.transaction(function(t){t.executeSql("DELETE FROM dbVersions where name = ? ",[o],function(){s.result=void 0;var t=e.Event("success");t.newVersion=null,t.oldVersion=u,e.util.callback("onsuccess",s,t)},i)},i)}var s=new e.IDBOpenRequest,a=!1,u=null;return n.transaction(function(n){n.executeSql("SELECT * FROM dbVersions where name = ?",[o],function(n,a){if(0===a.rows.length){s.result=void 0;var c=e.Event("success");return c.newVersion=null,c.oldVersion=u,e.util.callback("onsuccess",s,c),void 0}u=a.rows.item(0).version;var d=window.openDatabase(o,1,o,t);d.transaction(function(t){t.executeSql("SELECT * FROM __sys__",[],function(t,n){var o=n.rows;(function s(n){n>=o.length?t.executeSql("DROP TABLE __sys__",[],function(){r()},i):t.executeSql("DROP TABLE "+e.util.quote(o.item(n).name),[],function(){s(n+1)},function(){s(n+1)})})(0)},function(){r()})},i)})},i),s},cmp:function(t,n){return e.Key.encode(t)>e.Key.encode(n)?1:t===n?0:-1}};e.shimIndexedDB=o}}(idbModules),function(e,t){e.openDatabase!==void 0&&(e.shimIndexedDB=t.shimIndexedDB,e.shimIndexedDB&&(e.shimIndexedDB.__useShim=function(){e.indexedDB=t.shimIndexedDB,e.IDBDatabase=t.IDBDatabase,e.IDBTransaction=t.IDBTransaction,e.IDBCursor=t.IDBCursor,e.IDBKeyRange=t.IDBKeyRange},e.shimIndexedDB.__debug=function(e){t.DEBUG=e})),e.indexedDB=e.indexedDB||e.webkitIndexedDB||e.mozIndexedDB||e.oIndexedDB||e.msIndexedDB,e.indexedDB===void 0&&e.openDatabase!==void 0?e.shimIndexedDB.__useShim():(e.IDBDatabase=e.IDBDatabase||e.webkitIDBDatabase,e.IDBTransaction=e.IDBTransaction||e.webkitIDBTransaction,e.IDBCursor=e.IDBCursor||e.webkitIDBCursor,e.IDBKeyRange=e.IDBKeyRange||e.webkitIDBKeyRange,e.IDBTransaction||(e.IDBTransaction={}),e.IDBTransaction.READ_ONLY=e.IDBTransaction.READ_ONLY||"readonly",e.IDBTransaction.READ_WRITE=e.IDBTransaction.READ_WRITE||"readwrite")}(window,idbModules);
//@ sourceMappingURL=http://nparashuram.com/IndexedDBShim/dist/IndexedDBShim.min.map;
/** @license MIT - Â©2013 Ruben Verborgh */
!function(){function e(){var c=function(u,f,i){if(u!==c){var v=e();return c.c.push({d:v,resolve:u,reject:f}),v.promise}for(var s=f?"resolve":"reject",a=0,p=c.c.length;p>a;a++){var h=c.c[a],l=h.d,j=h[s];typeof j!==t?l[s](i):n(j,i,l)}c=r(o,i,f)},o={then:function(e,r){return c(e,r)}};return c.c=[],{promise:o,resolve:function(e){c.c&&c(c,!0,e)},reject:function(e){c.c&&c(c,!1,e)}}}function r(r,c,o){return function(u,f){var i,v=o?u:f;return typeof v!==t?r:(n(v,c,i=e()),i.promise)}}function n(e,r,n){setTimeout(function(){try{var c=e(r);c&&typeof c.then===t?c.then(n.resolve,n.reject):n.resolve(c)}catch(o){n.reject(o)}})}var t="function";window.promiscuous={resolve:function(e){var n={};return n.then=r(n,e,!0),n},reject:function(e){var n={};return n.then=r(n,e,!1),n},deferred:e}}();;
(function(){var l=new function(){function d(a){return a?0:-1}var f=this.priority=function(a,b){for(var c=a.exprs,e=0,f=0,d=c.length;f<d;f++){var g=c[f];if(!~(g=g.e(g.v,b instanceof Date?b.getTime():b,b)))return-1;e+=g}return e},e=this.parse=function(a,b){a||(a={$eq:a});var c=[];if(a.constructor==Object)for(var d in a){var m=k[d]?d:"$trav",j=a[d],g=j;if(h[m]){if(~d.indexOf(".")){g=d.split(".");d=g.shift();for(var n={},l=n,p=0,s=g.length-1;p<s;p++)l=l[g[p]]={};l[g[p]]=j;g=j=n}if(j instanceof Array){g=
[];for(n=j.length;n--;)g.push(e(j[n]))}else g=e(j,d)}c.push(r(m,d,g))}else c.push(r("$eq",d,a));var q={exprs:c,k:b,test:function(a){return!!~q.priority(a)},priority:function(a){return f(q,a)}};return q},h=this.traversable={$and:!0,$or:!0,$nor:!0,$trav:!0,$not:!0},k=this.testers={$eq:function(a,b){return d(a.test(b))},$ne:function(a,b){return d(!a.test(b))},$lt:function(a,b){return a>b?0:-1},$gt:function(a,b){return a<b?0:-1},$lte:function(a,b){return a>=b?0:-1},$gte:function(a,b){return a<=b?0:-1},
$exists:function(a,b){return a===(null!=b)?0:-1},$in:function(a,b){if(b instanceof Array)for(var c=b.length;c--;){if(~a.indexOf(b[c]))return c}else return d(~a.indexOf(b));return-1},$not:function(a,b){if(!a.test)throw Error("$not test should include an expression, not a value. Use $ne instead.");return d(!a.test(b))},$type:function(a,b,c){return c?c instanceof a||c.constructor==a?0:-1:-1},$nin:function(a,b){return~k.$in(a,b)?-1:0},$mod:function(a,b){return b%a[0]==a[1]?0:-1},$all:function(a,b){for(var c=
a.length;c--;)if(-1==b.indexOf(a[c]))return-1;return 0},$size:function(a,b){return b?a==b.length?0:-1:-1},$or:function(a,b){for(var c=a.length,d=c;c--;)if(~f(a[c],b))return c;return 0==d?0:-1},$nor:function(a,b){for(var c=a.length;c--;)if(~f(a[c],b))return-1;return 0},$and:function(a,b){for(var c=a.length;c--;)if(!~f(a[c],b))return-1;return 0},$trav:function(a,b){if(b instanceof Array){for(var c=b.length;c--;){var d=b[c];if(d[a.k]&&~f(a,d[a.k]))return c}return-1}return f(a,b?b[a.k]:void 0)}},m={$eq:function(a){return a instanceof
RegExp?a:{test:a instanceof Function?a:function(b){return b instanceof Array?~b.indexOf(a):a==b}}},$ne:function(a){return m.$eq(a)}},r=function(a,b,c){c=c instanceof Date?c.getTime():c;return{k:b,v:m[a]?m[a](c):c,e:k[a]}}},h=function(d,f,e){"object"!=typeof f&&(e=f,f=void 0);if(e){if("function"!=typeof e)throw Error("Unknown sift selector "+e);}else e=function(d){return d};var h=e,k=l.parse(d);e=function(d){for(var e=[],a,b,c=0,f=d.length;c<f;c++)a=h(d[c]),~(b=k.priority(a))&&e.push({value:a,priority:b});
e.sort(function(a,b){return a.priority>b.priority?-1:1});d=Array(e.length);for(c=e.length;c--;)d[c]=e[c].value;return d};e.test=k.test;e.score=k.priority;e.query=d;return f?e(f):e};h.use=function(d){d.operators&&h.useOperators(d.operators)};h.useOperators=function(d){for(var f in d)h.useOperator(f,d[f])};h.useOperator=function(d,f){var e={},e="object"==typeof f?f:{test:f},h="$"+d;l.testers[h]=e.test;if(e.traversable||e.traverse)l.traversable[h]=!0};"undefined"!=typeof module&&"undefined"!=typeof module.exports?
module.exports=h:"undefined"!=typeof window&&(window.sift=h)})();
;
/*!
 * Copyright (c) 2013 Kinvey, Inc. All rights reserved.
 *
 * Licensed to Kinvey, Inc. under one or more contributor
 * license agreements.  See the NOTICE file distributed with
 * this work for additional information regarding copyright
 * ownership.  Kinvey, Inc. licenses this file to you under the
 * Apache License, Version 2.0 (the "License"); you may not
 * use this file except in compliance with the License.  You
 * may obtain a copy of the License at
 *
 *         http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */
!function(){var a=this,b=function(){var c=function(a){var c=b();return null!=a&&c.init(a),c};c.API_ENDPOINT="https://baas.kinvey.com",c.API_VERSION="3",c.SDK_VERSION="1.0.2",c.appKey=null,c.appSecret=null,c.masterSecret=null;var d="appdata",e="blob",f="rpc",g="user",h=null,i=function(){var a=w.get("activeUser");return a.then(function(a){if(null!=a){var b=c.setActiveUser({_id:a[0],_kmd:{authtoken:a[1]}});return c.User.me().then(null,function(a){return c.Error.INVALID_CREDENTIALS===a.name&&c.setActiveUser(b),c.Defer.reject(a)})}return c.getActiveUser()})};c.getActiveUser=function(){return h},c.setActiveUser=function(a){if(null!=a&&(null==a._kmd||null==a._kmd.authtoken))throw new c.Error("user argument must contain: _kmd.authtoken.");var b=c.getActiveUser();return h=a,null!=a?w.save("activeUser",[a._id,a._kmd.authtoken]):w.destroy("activeUser"),b},c.init=function(a){if(a=a||{},null==a.appKey)throw new c.Error("options argument must contain: appKey.");if(null==a.appSecret&&null==a.masterSecret)throw new c.Error("options argument must contain: appSecret and/or masterSecret.");c.appKey=a.appKey,c.appSecret=null!=a.appSecret?a.appSecret:null,c.masterSecret=null!=a.masterSecret?a.masterSecret:null;var b=c.Sync.init(a.sync).then(i);return m(b,a)},c.ping=function(a){a=a||{},a.nocache=null==c.appKey?!1:a.nocache;var b=c.Persistence.read({namespace:d,auth:null!=c.appKey?y.All:y.None},a);return m(b,a)},c.Error=function(a){this.name="Kinvey.Error",this.message=a,this.stack=(new Error).stack},c.Error.prototype=new Error,c.Error.prototype.constructor=c.Error,c.Error.ENTITY_NOT_FOUND="EntityNotFound",c.Error.COLLECTION_NOT_FOUND="CollectionNotFound",c.Error.APP_NOT_FOUND="AppNotFound",c.Error.USER_NOT_FOUND="UserNotFound",c.Error.BLOB_NOT_FOUND="BlobNotFound",c.Error.INVALID_CREDENTIALS="InvalidCredentials",c.Error.KINVEY_INTERNAL_ERROR_RETRY="KinveyInternalErrorRetry",c.Error.KINVEY_INTERNAL_ERROR_STOP="KinveyInternalErrorStop",c.Error.USER_ALREADY_EXISTS="UserAlreadyExists",c.Error.USER_UNAVAILABLE="UserUnavailable",c.Error.DUPLICATE_END_USERS="DuplicateEndUsers",c.Error.INSUFFICIENT_CREDENTIALS="InsufficientCredentials",c.Error.WRITES_TO_COLLECTION_DISALLOWED="WritesToCollectionDisallowed",c.Error.INDIRECT_COLLECTION_ACCESS_DISALLOWED="IndirectCollectionAccessDisallowed",c.Error.APP_PROBLEM="AppProblem",c.Error.PARAMETER_VALUE_OUT_OF_RANGE="ParameterValueOutOfRange",c.Error.CORS_DISABLED="CORSDisabled",c.Error.INVALID_QUERY_SYNTAX="InvalidQuerySyntax",c.Error.MISSING_QUERY="MissingQuery",c.Error.JSON_PARSE_ERROR="JSONParseError",c.Error.MISSING_REQUEST_HEADER="MissingRequestHeader",c.Error.INCOMPLETE_REQUEST_BODY="IncompleteRequestBody",c.Error.MISSING_REQUEST_PARAMETER="MissingRequestParameter",c.Error.INVALID_IDENTIFIER="InvalidIdentifier",c.Error.BAD_REQUEST="BadRequest",c.Error.FEATURE_UNAVAILABLE="FeatureUnavailable",c.Error.API_VERSION_NOT_IMPLEMENTED="APIVersionNotImplemented",c.Error.API_VERSION_NOT_AVAILABLE="APIVersionNotAvailable",c.Error.INPUT_VALIDATION_FAILED="InputValidationFailed",c.Error.BL_RUNTIME_ERROR="BLRuntimeError",c.Error.BL_SYNTAX_ERROR="BLSyntaxError",c.Error.BL_TIMEOUT_ERROR="BLTimeoutError",c.Error.OAUTH_TOKEN_REFRESH_ERROR="OAuthTokenRefreshError",c.Error.BL_VIOLATION_ERROR="BLViolationError",c.Error.BL_INTERNAL_ERROR="BLInternalError",c.Error.THIRD_PARTY_TOS_UNACKED="ThirdPartyTOSUnacked",c.Error.STALE_REQUEST="StaleRequest",c.Error.DATA_LINK_PARSE_ERROR="DataLinkParseError",c.Error.NOT_IMPLEMENTED_ERROR="NotImplementedError",c.Error.DATABASE_ERROR="DatabaseError",c.Error.MISSING_APP_CREDENTIALS="MissingAppCredentials",c.Error.MISSING_MASTER_CREDENTIALS="MissingMasterCredentials",c.Error.NO_ACTIVE_USER="NoActiveUser",c.Error.REQUEST_ABORT_ERROR="RequestAbortError",c.Error.REQUEST_ERROR="RequestError",c.Error.REQUEST_TIMEOUT_ERROR="RequestTimeoutError",c.Error.SOCIAL_ERROR="SocialError",c.Error.SYNC_ERROR="SyncError";var j={};j[c.Error.DATABASE_ERROR]={name:c.Error.DATABASE_ERROR,description:"The database used for local persistence encountered an error.",debug:""},j[c.Error.MISSING_APP_CREDENTIALS]={name:c.Error.MISSING_APP_CREDENTIALS,description:"Missing credentials: `Kinvey.appKey` and/or `Kinvey.appSecret`.",debug:"Did you forget to call `Kinvey.init`?"},j[c.Error.MISSING_MASTER_CREDENTIALS]={name:c.Error.MISSING_MASTER_CREDENTIALS,description:"Missing credentials: `Kinvey.appKey` and/or `Kinvey.masterSecret`.",debug:"Did you forget to call `Kinvey.init` with your Master Secret?"},j[c.Error.NO_ACTIVE_USER]={name:c.Error.NO_ACTIVE_USER,description:"No active user.",debug:"Try creating a user or logging in first."},j[c.Error.REQUEST_ABORT_ERROR]={name:c.Error.REQUEST_TIMEOUT_ERROR,description:"The request was aborted.",debug:""},j[c.Error.REQUEST_ERROR]={name:c.Error.REQUEST_ERROR,description:"The request failed.",debug:""},j[c.Error.REQUEST_TIMEOUT_ERROR]={name:c.Error.REQUEST_TIMEOUT_ERROR,description:"The request timed out.",debug:""},j[c.Error.SOCIAL_ERROR]={name:c.Error.SOCIAL_ERROR,description:"The social identity cannot be obtained.",debug:""},j[c.Error.SYNC_ERROR]={name:c.Error.SYNC_ERROR,description:"The synchronization operation cannot be completed.",debug:""};var k,l=function(a,b){var c=j[a]||{name:a};return b=b||{},{name:c.name,description:b.description||c.description||"",debug:b.debug||c.debug||""}};k="function"==typeof a.setImmediate?a.setImmediate:"undefined"!=typeof process&&process.nextTick?process.nextTick:function(b){a.setTimeout(b,0)};var m=function(a,b){return a.then(function(a){b.success&&b.success(a)},function(a){b.error&&b.error(a)}).then(null,function(a){k(function(){throw a})}),a},n=Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},o=function(a){return"function"!=typeof/ . /?"function"==typeof a:"[object Function]"===Object.prototype.toString.call(a)},p=function(a){return"[object Number]"===Object.prototype.toString.call(a)&&!isNaN(a)},q=function(a){return Object(a)===a},r=function(a){return"[object RegExp]"===Object.prototype.toString.call(a)},s=function(a){return"[object String]"===Object.prototype.toString.call(a)},t=function(a){if(null==a)return!0;if(n(a)||s(a))return 0===a.length;for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},u=function(a){return function(){throw new c.Error("Method not implemented: "+a)}},v=function(a){return function(b){var d=this;b=b||{},a.forEach(function(a){if("function"!=typeof b[a])throw new c.Error("Adapter must implement method: "+a)}),a.forEach(function(a){d[a]=function(){return b[a].apply(b,arguments)}})}},w={destroy:function(a){return w._destroy(w._key(a))},get:function(a){return w._get(w._key(a))},save:function(a,b){return w._save(w._key(a),b)},_destroy:u("Storage.destroy"),_get:u("Storage.get"),_key:function(a){return["Kinvey",c.appKey,a].join(".")},_save:u("Storage.set"),use:v(["_destroy","_get","_save"])};c.Defer={all:function(a){if(!n(a))throw new c.Error("promises argument must be of type: Array.");var b=a.length;if(0===b)return c.Defer.resolve([]);var d=c.Defer.deferred(),e=[];return a.forEach(function(a,c){a.then(function(a){b-=1,e[c]=a,0===b&&d.resolve(e)},function(a){d.reject(a)})}),d.promise},resolve:function(a){var b=c.Defer.deferred();return b.resolve(a),b.promise},reject:function(a){var b=c.Defer.deferred();return b.reject(a),b.promise},deferred:u("Kinvey.Defer.deferred"),use:v(["deferred"])};var x=null,y={All:function(){return y.Session().then(null,y.Basic)},App:function(){if(null==c.appKey||null==c.appSecret){var a=l(c.Error.MISSING_APP_CREDENTIALS);return c.Defer.reject(a)}var b=c.Defer.resolve({scheme:"Basic",username:c.appKey,password:c.appSecret});return b},Basic:function(){return y.Master().then(null,y.App)},Default:function(){return y.UserDefault().then(null,function(){return null===x&&(x=c.User.create().then(function(a){return x=null,a},function(a){return x=null,c.Defer.reject(a)})),x.then(y.Session)})},Master:function(){if(null==c.appKey||null==c.masterSecret){var a=l(c.Error.MISSING_MASTER_CREDENTIALS);return c.Defer.reject(a)}var b=c.Defer.resolve({scheme:"Basic",username:c.appKey,password:c.masterSecret});return b},None:function(){return c.Defer.resolve(null)},Session:function(){var a=c.getActiveUser();if(null===a){var b=l(c.Error.NO_ACTIVE_USER);return c.Defer.reject(b)}var d=c.Defer.resolve({scheme:"Kinvey",credentials:a._kmd.authtoken});return d},UserDefault:function(){return y.Session().then(null,y.Master)}},z=function(){var b,c,d,e,f,g=[],h=function(a){a=a.toLowerCase();var b=/(chrome)\/([\w]+)/,c=/(firefox)\/([\w.]+)/,d=/(msie) ([\w.]+)/i,e=/(opera)(?:.*version)?[ \/]([\w.]+)/,f=/(safari)\/([\w.]+)/;return b.exec(a)||c.exec(a)||d.exec(a)||e.exec(a)||f.exec(a)||[]};if("undefined"!=typeof a.cordova&&"undefined"!=typeof a.device){var i=a.device;g.push("phonegap/"+i.cordova),c=i.platform,d=i.version,e=i.model,f=i.uuid}else"undefined"!=typeof Titanium?(g.push("titanium/"+Titanium.getVersion()),"mobileweb"===Titanium.Platform.getName()?(b=h(Titanium.Platform.getModel()),c=b[1],d=b[2],e=Titanium.Platform.getOstype()):(c=Titanium.Platform.getOsname(),d=Titanium.Platform.getVersion(),e=Titanium.Platform.getManufacturer()),f=Titanium.Platform.getId()):"undefined"!=typeof process&&(c=process.title,d=process.version,e=process.platform);"undefined"!=typeof angular&&g.push("angularjs/"+angular.version.full),"undefined"!=typeof Backbone&&g.push("backbonejs/"+Backbone.VERSION),"undefined"!=typeof Ember&&g.push("emberjs/"+Ember.VERSION),"undefined"!=typeof jQuery&&g.push("jquery/"+jQuery.fn.jquery),"undefined"!=typeof ko&&g.push("knockout/"+ko.version),"undefined"!=typeof Zepto&&g.push("zeptojs"),null==c&&a.navigator&&(b=h(a.navigator.userAgent),c=b[1],d=b[2],e=a.navigator.platform);var j=["js-backbone/1.0.2"];return 0!==g.length&&j.push("("+g.sort().join(", ")+")"),j.concat([c,d,e,f].map(function(a){return null!=a?a.toString().replace(/\s/g,"_").toLowerCase():"unknown"})).join(" ")};c.Acl=function(a){if(null!=a&&!q(a))throw new c.Error("document argument must be of type: Object.");a=a||{},a._acl=a._acl||{},this._acl=a._acl},c.Acl.prototype={addReader:function(a){return this._acl.r=this._acl.r||[],-1===this._acl.r.indexOf(a)&&this._acl.r.push(a),this},addReaderGroup:function(a){return this._acl.groups=this._acl.groups||{},this._acl.groups.r=this._acl.groups.r||[],-1===this._acl.groups.r.indexOf(a)&&this._acl.groups.r.push(a),this},addWriterGroup:function(a){return this._acl.groups=this._acl.groups||{},this._acl.groups.w=this._acl.groups.w||[],-1===this._acl.groups.w.indexOf(a)&&this._acl.groups.w.push(a),this},addWriter:function(a){return this._acl.w=this._acl.w||[],-1===this._acl.w.indexOf(a)&&this._acl.w.push(a),this},getCreator:function(){return this._acl.creator||null},getReaders:function(){return this._acl.r||[]},getReaderGroups:function(){return this._acl.groups?this._acl.groups.r:[]},getWriterGroups:function(){return this._acl.groups?this._acl.groups.w:[]},getWriters:function(){return this._acl.w||[]},isGloballyReadable:function(){return this._acl.gr||!1},isGloballyWritable:function(){return this._acl.gw||!1},removeReader:function(a){var b;return this._acl.r&&-1!==(b=this._acl.r.indexOf(a))&&this._acl.r.splice(b,1),this},removeReaderGroup:function(a){var b;return this._acl.groups&&this._acl.groups.r&&-1!==(b=this._acl.groups.r.indexOf(a))&&this._acl.groups.r.splice(b,1),this},removeWriterGroup:function(a){var b;return this._acl.groups&&this._acl.groups.w&&-1!==(b=this._acl.groups.w.indexOf(a))&&this._acl.groups.w.splice(b,1),this},removeWriter:function(a){var b;return this._acl.w&&-1!==(b=this._acl.w.indexOf(a))&&this._acl.w.splice(b,1),this},setGloballyReadable:function(a){return this._acl.gr=a||!1,this},setGloballyWritable:function(a){return this._acl.gw=a||!1,this},toJSON:function(){return this._acl}},c.Group=function(){this._query=null,this._initial={},this._key={},this._reduce=function(){}.toString()},c.Group.prototype={by:function(a){return this._key[a]=!0,this},initial:function(a,b){if("undefined"==typeof b&&!q(a))throw new c.Error("objectOrKey argument must be of type: Object.");return q(a)?this._initial=a:this._initial[a]=b,this},postProcess:function(a){return null===this._query?a:this._query._postProcess(a)},query:function(a){if(!(a instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");return this._query=a,this},reduce:function(a){if(o(a)&&(a=a.toString()),!s(a))throw new c.Error("fn argument must be of type: function or string.");return this._reduce=a,this},toJSON:function(){return{key:this._key,initial:this._initial,reduce:this._reduce,condition:null!==this._query?this._query.toJSON().filter:{}}}},c.Group.count=function(a){var b=new c.Group;return null!=a&&b.by(a),b.initial({result:0}),b.reduce(function(a,b){b.result+=1}),b},c.Group.sum=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({result:0}),b.reduce('function(doc, out) { out.result += doc["'+a+'"]; }'),b},c.Group.min=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({result:"Infinity"}),b.reduce('function(doc, out) { out.result = Math.min(out.result, doc["'+a+'"]); }'),b},c.Group.max=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({result:"-Infinity"}),b.reduce('function(doc, out) { out.result = Math.max(out.result, doc["'+a+'"]); }'),b},c.Group.average=function(a){a=a.replace("'","\\'");var b=new c.Group;return b.initial({count:0,result:0}),b.reduce('function(doc, out) {  out.result = (out.result * out.count + doc["'+a+'"]) / (out.count + 1);'+"  out.count += 1;"+"}"),b},c.execute=function(a,b,d){d=d||{};var e=c.Persistence.create({namespace:f,collection:"custom",id:a,data:b,auth:y.Default},d).then(null,function(a){return c.Error.REQUEST_ERROR===a.name&&q(a.debug)?c.Defer.reject(a.debug):c.Defer.reject(a)});return m(e,d)},c.DataStore={find:function(a,b,e){if(null!=b&&!(b instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");e=e||{};var f=c.Persistence.read({namespace:d,collection:a,query:b,auth:y.Default,local:{req:!0,res:!0}},e);return m(f,e)},get:function(a,b,e){e=e||{};var f=c.Persistence.read({namespace:d,collection:a,id:b,auth:y.Default,local:{req:!0,res:!0}},e);return m(f,e)},save:function(a,b,e){if(e=e||{},null!=b._id)return c.DataStore.update(a,b,e);var f=c.Persistence.create({namespace:d,collection:a,data:b,auth:y.Default,local:{req:!0,res:!0}},e);return m(f,e)},update:function(a,b,e){if(null==b._id)throw new c.Error("document argument must contain: _id");e=e||{};var f=c.Persistence.update({namespace:d,collection:a,id:b._id,data:b,auth:y.Default,local:{req:!0,res:!0}},e);return m(f,e)},clean:function(a,b,e){if(e=e||{},b=b||new c.Query,!(b instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");var f=c.Persistence.destroy({namespace:d,collection:a,query:b,auth:y.Default,local:{req:!0,res:!0}},e);return m(f,e)},destroy:function(a,b,e){e=e||{};var f=c.Persistence.destroy({namespace:d,collection:a,id:b,auth:y.Default,local:{req:!0,res:!0}},e).then(null,function(a){return e.silent&&c.Error.ENTITY_NOT_FOUND===a.name?{count:0}:c.Defer.reject(a)});return m(f,e)},count:function(a,b,e){if(null!=b&&!(b instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");e=e||{};var f=c.Persistence.read({namespace:d,collection:a,id:"_count",query:b,auth:y.Default,local:{req:!0}},e).then(function(a){return a.count});return m(f,e)},group:function(a,b,e){if(!(b instanceof c.Group))throw new c.Error("aggregation argument must be of type: Kinvey.Group.");e=e||{};var f=c.Persistence.create({namespace:d,collection:a,id:"_group",data:b.toJSON(),auth:y.Default,local:{req:!0}},e).then(function(a){return b.postProcess(a)});return m(f,e)}},c.File={destroy:function(a,b){b=b||{};var d=c.Persistence.destroy({namespace:e,id:a,auth:y.Default},b).then(null,function(a){return b.silent&&c.Error.BLOB_NOT_FOUND===a.name?{count:0}:c.Defer.reject(a)});return m(d,b)},download:function(a,b){b=b||{};var d={};!1!==b.tls&&(d.tls=!0),b.ttl&&(d.ttl_in_seconds=b.ttl);var f=c.Persistence.read({namespace:e,id:a,flags:d,auth:y.Default},b).then(function(a){if(b.stream)return a;var d=b.success,e=b.error;return delete b.success,delete b.error,c.File.downloadByUrl(a,b).then(function(a){return b.success=d,b.error=e,a},function(a){return b.success=d,b.error=e,c.Defer.reject(a)})});return m(f,b)},downloadByUrl:function(a,b){var d=q(a)?a:{_downloadURL:a};b=b||{},b.file=d.mimeType||"application-octet-stream",b.headers=b.headers||{},delete b.headers["Content-Type"];var e=d._downloadURL,f=c.Persistence.Net.request("GET",e,null,b.headers,b);return f=f.then(function(a){return d._data=a,d},function(a){var b=l(c.Error.REQUEST_ERROR,{description:"This file could not be downloaded from the provided URL.",debug:a});return c.Defer.reject(b)}),m(f,b)},find:function(a,b){if(null!=a&&!(a instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");b=b||{};var d={};!1!==b.tls&&(d.tls=!0),b.ttl&&(d.ttl_in_seconds=b.ttl);var f=c.Persistence.read({namespace:e,query:a,flags:d,auth:y.Default},b).then(function(a){if(b.download){var d=b.success,e=b.error;delete b.success,delete b.error;var f=a.map(function(a){return c.File.downloadByUrl(a,b)});return c.Defer.all(f).then(function(a){return b.success=d,b.error=e,a},function(a){return b.success=d,b.error=e,c.Defer.reject(a)})}return a});return m(f,b)},stream:function(a,b){return b=b||{},b.stream=!0,c.File.download(a,b)},upload:function(a,b,d){a=a||{},b=b||{},d=d||{},null!=b._filename||null==a._filename&&null==a.name||(b._filename=a._filename||a.name),null!=b.size||null==a.size&&null==a.length||(b.size=a.size||a.length),b.mimeType=b.mimeType||a.mimeType||a.type||"application/octet-stream",d.public&&(b._public=!0),d.contentType=b.mimeType;var f=null!=b._id?c.Persistence.update({namespace:e,id:b._id,data:b,flags:!1!==d.tls?{tls:!0}:null,auth:y.Default},d):c.Persistence.create({namespace:e,data:b,flags:!1!==d.tls?{tls:!0}:null,auth:y.Default},d);return f=f.then(function(b){var e=b._uploadURL,f=b._requiredHeaders||{};f["Content-Type"]=d.contentType,delete b._expiresAt,delete b._requiredHeaders,delete b._uploadURL;var g=c.Persistence.Net.request("PUT",e,a,f,d);return g.then(function(){return b._data=a,b})}),m(f,d)}},c.Metadata=function(a){if(!q(a))throw new c.Error("document argument must be of type: Object.");this._acl=null,this._document=a},c.Metadata.prototype={getAcl:function(){return null===this._acl&&(this._acl=new c.Acl(this._document)),this._acl},getCreatedAt:function(){return null!=this._document._kmd&&null!=this._document._kmd.ect?new Date(this._document._kmd.ect):null},getEmailVerification:function(){return null!=this._document._kmd&&null!=this._document._kmd.emailVerification?this._document._kmd.emailVerification.status:null},getLastModified:function(){return null!=this._document._kmd&&null!=this._document._kmd.lmt?new Date(this._document._kmd.lmt):null},setAcl:function(a){if(!(a instanceof c.Acl))throw new c.Error("acl argument must be of type: Kinvey.Acl.");return this._acl=null,this._document._acl=a.toJSON(),this},toJSON:function(){return this._document}};var A=["facebook","google","linkedIn","twitter"],B={use:v(A)};A.forEach(function(a){B[a]=u("Social."+a)}),c.Social={connect:function(a,b,d){if(d=d||{},d.create="undefined"!=typeof d.create?d.create:!0,!c.Social.isSupported(b))throw new c.Error("provider argument is not supported.");var e=d.success,f=d.error;delete d.success,delete d.error;var g=B[b](d).then(function(e){a=a||{};var f=c.getActiveUser();return a._socialIdentity=a._socialIdentity||{},a._socialIdentity[b]=e,null!==f&&f._id===a._id?(d._provider=b,c.User.update(a,d)):(a._socialIdentity={},a._socialIdentity[b]=e,c.User.login(a,null,d).then(null,function(b){return d.create&&c.Error.USER_NOT_FOUND===b.name?c.User.signup(a,d):c.Defer.reject(b)}))});return g=g.then(function(a){return d.success=e,d.error=f,a}),m(g,d)},disconnect:function(a,b,d){if(!c.Social.isSupported(b))throw new c.Error("provider argument is not supported.");if(a._socialIdentity=a._socialIdentity||{},a._socialIdentity[b]=null,null==a._id){var e=c.Defer.resolve(a);return m(e,d)}return c.User.update(a,d)},facebook:function(a,b){return c.Social.connect(a,"facebook",b)},google:function(a,b){return c.Social.connect(a,"google",b)},isSupported:function(a){return-1!==A.indexOf(a)},linkedIn:function(a,b){return c.Social.connect(a,"linkedIn",b)},twitter:function(a,b){return c.Social.connect(a,"twitter",b)}},c.User={signup:function(a,b){return b=b||{},b.state=!0,c.User.create(a,b)},login:function(a,b,d){return q(a)?d="undefined"!=typeof d?d:b:a={username:a,password:b},d=d||{},c.User.logout({force:!0,silent:!0}).then(function(){var b=c.Persistence.create({namespace:g,collection:d._provider?null:"login",data:a,flags:d._provider?{provider:d._provider}:{},auth:y.App,local:{res:!0}},d).then(function(a){return c.setActiveUser(a),a});return m(b,d)})},logout:function(a){a=a||{};var b;return b=a.silent&&null===c.getActiveUser()?c.Defer.resolve(null):c.Persistence.create({namespace:g,collection:"_logout",auth:y.Session},a).then(null,function(b){return a.force&&c.Error.INVALID_CREDENTIALS===b.name?null:c.Defer.reject(b)}).then(function(){var a=c.setActiveUser(null);return null!==a&&delete a._kmd.authtoken,a}),m(b,a)},me:function(a){a=a||{};var b=c.Persistence.read({namespace:g,collection:"_me",auth:y.Session,local:{req:!0,res:!0}},a).then(function(a){return a._kmd=a._kmd||{},a._kmd.authtoken=c.getActiveUser()._kmd.authtoken,c.setActiveUser(a),a});return m(b,a)},verifyEmail:function(a,b){b=b||{};var d=c.Persistence.create({namespace:f,collection:a,id:"user-email-verification-initiate",auth:y.App},b);return m(d,b)},forgotUsername:function(a,b){b=b||{};var d=c.Persistence.create({namespace:f,id:"user-forgot-username",data:{email:a},auth:y.App},b);return m(d,b)},resetPassword:function(a,b){b=b||{};var d=c.Persistence.create({namespace:f,collection:a,id:"user-password-reset-initiate",auth:y.App},b);return m(d,b)},exists:function(a,b){b=b||{};var d=c.Persistence.create({namespace:f,id:"check-username-exists",data:{username:a},auth:y.App},b).then(function(a){return a.usernameExists});return m(d,b)},create:function(a,b){b=b||{};var d;return d=!1!==b.state?c.User.logout({force:!0,silent:!0}):c.Defer.resolve(null),d.then(function(){var d=c.Persistence.create({namespace:g,data:a||{},auth:y.App},b).then(function(a){return!1!==b.state&&c.setActiveUser(a),a});return m(d,b)})},update:function(a,b){if(null==a._id)throw new c.Error("data argument must contain: _id");b=b||{};var d=[];if(null!=a._socialIdentity)for(var e in a._socialIdentity)a._socialIdentity.hasOwnProperty(e)&&null!=a._socialIdentity[e]&&e!==b._provider&&(d.push({provider:e,access_token:a._socialIdentity[e].access_token,access_token_secret:a._socialIdentity[e].access_token_secret}),delete a._socialIdentity[e].access_token,delete a._socialIdentity[e].access_token_secret);var f=c.Persistence.update({namespace:g,id:a._id,data:a,auth:y.UserDefault,local:{res:!0}},b).then(function(a){d.forEach(function(b){var c=b.provider;null!=a._socialIdentity&&null!=a._socialIdentity[c]&&["access_token","access_token_secret"].forEach(function(d){null!=b[d]&&(a._socialIdentity[c][d]=b[d])})});var b=c.getActiveUser();return null!==b&&b._id===a._id&&c.setActiveUser(a),a});return m(f,b)},find:function(a,b){if(null!=a&&!(a instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");b=b||{};var d;return d=b.discover?c.Persistence.create({namespace:g,collection:"_lookup",data:null!=a?a.toJSON().filter:null,auth:y.Default,local:{req:!0,res:!0}},b):c.Persistence.read({namespace:g,query:a,auth:y.Default,local:{req:!0,res:!0}},b),m(d,b)},get:function(a,b){b=b||{};var d=c.Persistence.read({namespace:g,id:a,auth:y.Default,local:{req:!0,res:!0}},b);return m(d,b)},destroy:function(a,b){b=b||{};var d=c.Persistence.destroy({namespace:g,id:a,flags:b.hard?{hard:!0}:{},auth:y.UserDefault,local:{res:!0}},b).then(function(b){var d=c.getActiveUser();return null!==d&&d._id===a&&c.setActiveUser(null),b},function(a){return b.silent&&c.Error.USER_NOT_FOUND===a.name?null:c.Defer.reject(a)});return m(d,b)},restore:function(a,b){b=b||{};var d=c.Persistence.create({namespace:g,collection:a,id:"_restore",auth:y.Master},b);return m(d,b)},count:function(a,b){if(null!=a&&!(a instanceof c.Query))throw new c.Error("query argument must be of type: Kinvey.Query.");b=b||{};var d=c.Persistence.read({namespace:g,id:"_count",query:a,auth:y.Default,local:{req:!0}},b).then(function(a){return a.count});return m(d,b)},group:function(a,b){if(!(a instanceof c.Group))throw new c.Error("aggregation argument must be of type: Kinvey.Group.");b=b||{};var d=c.Persistence.create({namespace:g,id:"_group",data:a.toJSON(),auth:y.Default,local:{req:!0}},b).then(function(b){return a.postProcess(b)});return m(d,b)}},c.Query=function(a){a=a||{},this._filter=a.filter||{},this._sort=a.sort||{},this._limit=a.limit||null,this._skip=a.skip||0,this._parent=null},c.Query.prototype={equalTo:function(a,b){return this._filter[a]=b,this},contains:function(a,b){if(!n(b))throw new c.Error("values argument must be of type: Array.");return this._addFilter(a,"$in",b)},containsAll:function(a,b){if(!n(b))throw new c.Error("values argument must be of type: Array.");return this._addFilter(a,"$all",b)},greaterThan:function(a,b){if(!p(b)&&!s(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$gt",b)},greaterThanOrEqualTo:function(a,b){if(!p(b)&&!s(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$gte",b)},lessThan:function(a,b){if(!p(b)&&!s(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$lt",b)},lessThanOrEqualTo:function(a,b){if(!p(b)&&!s(b))throw new c.Error("value argument must be of type: number or string.");return this._addFilter(a,"$lte",b)},notEqualTo:function(a,b){return this._addFilter(a,"$ne",b)},notContainedIn:function(a,b){if(!n(b))throw new c.Error("values argument must be of type: Array.");return this._addFilter(a,"$nin",b)},and:function(){return this._join("$and",Array.prototype.slice.call(arguments))},nor:function(){return null!==this._parent&&null!=this._parent._filter.$and?this._parent.nor.apply(this._parent,arguments):this._join("$nor",Array.prototype.slice.call(arguments))},or:function(){return null!==this._parent?this._parent.or.apply(this._parent,arguments):this._join("$or",Array.prototype.slice.call(arguments))},exists:function(a,b){return b="undefined"==typeof b?!0:b||!1,this._addFilter(a,"$exists",b)},mod:function(a,b,d){if(s(b)&&(b=parseFloat(b)),"undefined"==typeof d?d=0:s(d)&&(d=parseFloat(d)),!p(b))throw new c.Error("divisor arguments must be of type: number.");if(!p(d))throw new c.Error("remainder argument must be of type: number.");return this._addFilter(a,"$mod",[b,d])},matches:function(a,b,c){r(b)||(b=new RegExp(b)),c=c||{};var d=[];(b.ignoreCase||c.ignoreCase)&&!1!==c.ignoreCase&&d.push("i"),(b.multiline||c.multiline)&&!1!==c.multiline&&d.push("m"),c.extended&&d.push("x"),c.dotMatchesAll&&d.push("s");var e=this._addFilter(a,"$regex",b.source);return 0!==d.length&&this._addFilter(a,"$options",d.join("")),e},near:function(a,b,d){if(!n(b)||null==b[0]||null==b[1])throw new c.Error("coord argument must be of type: Array.<number, number>.");b[0]=parseFloat(b[0]),b[1]=parseFloat(b[1]);var e=this._addFilter(a,"$near",[b[0],b[1]]);return null!=d&&this._addFilter(a,"$maxDistance",d),e},withinBox:function(a,b,d){if(!n(b)||null==b[0]||null==b[1])throw new c.Error("bottomLeftCoord argument must be of type: Array.<number, number>.");if(!n(d)||null==d[0]||null==d[1])throw new c.Error("upperRightCoord argument must be of type: Array.<number, number>.");b[0]=parseFloat(b[0]),b[1]=parseFloat(b[1]),d[0]=parseFloat(d[0]),d[1]=parseFloat(d[1]);var e=[[b[0],b[1]],[d[0],d[1]]];return this._addFilter(a,"$within",{$box:e})},withinPolygon:function(a,b){if(!n(b)||3>b.length)throw new c.Error("coords argument must be of type: Array.Array.<number, number>.");return b=b.map(function(a){if(null==a[0]||null==a[1])throw new c.Error("coords argument must be of type: Array.Array.<number, number>.");return[parseFloat(a[0]),parseFloat(a[1])]}),this._addFilter(a,"$within",{$polygon:b})},size:function(a,b){if(s(b)&&(b=parseFloat(b)),!p(b))throw new c.Error("size argument must be of type: number.");return this._addFilter(a,"$size",b)},limit:function(a){if(a=a||null,s(a)&&(a=parseFloat(a)),null!=a&&!p(a))throw new c.Error("limit argument must be of type: number.");return null!==this._parent?this._parent.limit(a):this._limit=a,this},skip:function(a){if(s(a)&&(a=parseFloat(a)),!p(a))throw new c.Error("skip argument must be of type: number.");return null!==this._parent?this._parent.skip(a):this._skip=a,this},ascending:function(a){return null!==this._parent?this._parent.ascending(a):this._sort[a]=1,this},descending:function(a){return null!==this._parent?this._parent.descending(a):this._sort[a]=-1,this},sort:function(a){if(null!=a&&!q(a))throw new c.Error("sort argument must be of type: Object.");return null!==this._parent?this._parent.sort(a):this._sort=a||{},this},toJSON:function(){return null!==this._parent?this._parent.toJSON():{filter:this._filter,sort:this._sort,skip:this._skip,limit:this._limit}},_addFilter:function(a,b,c){return q(this._filter[a])||(this._filter[a]={}),this._filter[a][b]=c,this},_join:function(a,b){var d=this;b=b.map(function(a){if(!(a instanceof c.Query)){if(!q(a))throw new c.Error("query argument must be of type: Kinvey.Query[] or Object[].");a=new c.Query(a)}return a.toJSON().filter}),0===b.length&&(d=new c.Query,b=[d.toJSON().filter],d._parent=this);var e={};for(var f in this._filter)this._filter.hasOwnProperty(f)&&(e[f]=this._filter[f],delete this._filter[f]);return this._filter[a]=[e].concat(b),d},_postProcess:function(a){if(!n(a))throw new c.Error("response argument must be of type: Array.");var b=this;return a=a.sort(function(a,c){for(var d in b._sort)if(b._sort.hasOwnProperty(d)){if("undefined"!=typeof a[d]&&"undefined"==typeof c[d])return-1;if("undefined"!=typeof c[d]&&"undefined"==typeof a[d])return 1;if(a[d]!==c[d]){var e=b._sort[d];return(a[d]<c[d]?-1:1)*e}}return 0}),null!==this._limit?a.slice(this._skip,this._skip+this._limit):a.slice(this._skip)}};var C=function(a,b,c){if(!b)return a="undefined"==typeof c?a:c;for(var d,e=a,f=b.split(".");(d=f.shift())&&null!=e&&e.hasOwnProperty(d);){if(0===f.length)return e[d]="undefined"==typeof c?e[d]:c,e[d];e=e[d]}return null},D={get:function(a,b){if(n(a)){var d=a.map(function(a){return D.get(a,b)});return c.Defer.all(d)}b=b||{},b.exclude=b.exclude||[],b.relations=b.relations||{};var e=b.error,f=b.relations,h=b.success;delete b.error,delete b.relations,delete b.success;var i=[];Object.keys(f).forEach(function(a){var b=a.split(".").length;i[b]=(i[b]||[]).concat(a)});var j=c.Defer.resolve(null);return i.forEach(function(d){j=j.then(function(){var e=d.map(function(d){var e=C(a,d),f=n(e),h=(f?e:[e]).map(function(a){if(null==a||"KinveyRef"!==a._type||-1!==b.exclude.indexOf(d))return c.Defer.resolve(a);var e;return e=g===a._collection?c.User.get(a._id,b):c.DataStore.get(a._collection,a._id,b),e.then(null,function(){return c.Defer.resolve(a)})});return c.Defer.all(h).then(function(b){C(a,d,f?b:b[0])})});return c.Defer.all(e)})}),j.then(function(){return b.error=e,b.relations=f,b.success=h,a},function(a){return b.error=e,b.relations=f,b.success=h,c.Defer.reject(a)})},save:function(a,b,d){if(n(b)){var e=b.map(function(b){return D.save(a,b,d)});return c.Defer.all(e)}d=d||{},d.exclude=d.exclude||[],d.relations=d.relations||{};var f=d.error,h=d.relations,i=d.success;delete d.error,delete d.relations,delete d.success;var j=[];h[""]=a,Object.keys(h).forEach(function(a){var b=""===a?0:a.split(".").length;j[b]=(j[b]||[]).concat(a)});var k={},l=c.Defer.resolve(null);return j.reverse().forEach(function(a){l=l.then(function(){var e=a.map(function(a){var e=h[a],f=C(b,a),i=n(f),j=(i?f:[f]).map(function(b){if(null==b||"KinveyRef"===b._type||-1!==d.exclude.indexOf(a))return c.Defer.resolve(b);
var f;if(g===e){var h=null==b._id;d.state=h&&""!==a?d.state||!1:d.state,f=c.User[h?"create":"update"](b,d)}else f=c.DataStore.save(e,b,d);return f.then(null,function(e){return d.force&&""!==a?b:c.Defer.reject(e)})});return c.Defer.all(j).then(function(c){var d=c.map(function(a){return null==a||null==a._id?a:{_type:"KinveyRef",_collection:e,_id:a._id}});i||(d=d[0],c=c[0]),C(b,a,d),k[a]=c})});return c.Defer.all(e)})}),l.then(function(){var a=k[""];return j.reverse().forEach(function(b){b.forEach(function(b){C(a,b,k[b])})}),delete h[""],d.error=f,d.relations=h,d.success=i,a},function(a){return delete h[""],d.error=f,d.relations=h,d.success=i,c.Defer.reject(a)})}},E=function(a){var b=c.Sync.isEnabled(),d=c.Sync.isOnline();return a.fallback=b&&d&&!1!==a.fallback,a.offline=b&&(!d||a.offline),a.refresh=b&&d&&!1!==a.refresh,a};c.Persistence={create:function(a,b){if(b.relations){var d=g===a.namespace?g:a.collection;return D.save(d,a.data,b)}if(a.local=a.local||{},b=E(b),a.local.req&&b.offline)return c.Persistence.Local.create(a,b).then(null,function(d){return b.fallback&&"_group"===a.id?(b.offline=!1,c.Persistence.create(a,b)):c.Defer.reject(d)});var e=c.Persistence.Net.create(a,b);return a.local.res&&b.refresh?e.then(function(d){return a.data=d,c.Persistence.Local.create(a,b).then(function(){return d})}):e},read:function(a,b){if(a.local=a.local||{},b=E(b),a.local.req&&b.offline)return c.Persistence.Local.read(a,b).then(null,function(d){return b.fallback?(b.offline=!1,c.Persistence.read(a,b)):c.Defer.reject(d)});var d=c.Persistence.Net.read(a,b);return a.local.res&&b.refresh?d.then(function(d){var e;if(b.relations){var f=b.offline;b.offline=!0,b.track=!1;var h=g===a.namespace?g:a.collection;e=D.save(h,d,b).then(function(){b.offline=f,delete b.track})}else a.data=d,e=c.Persistence.Local.create(a,b);return e.then(function(){return d})},function(d){return c.Error.ENTITY_NOT_FOUND===d.name?c.Persistence.Local.destroy(a,b).then(function(){return c.Defer.reject(d)}):c.Defer.reject(d)}):d},update:function(a,b){if(b.relations){var d=g===a.namespace?g:a.collection;return D.save(d,a.data,b)}if(a.local=a.local||{},b=E(b),a.local.req&&b.offline)return c.Persistence.Local.update(a,b);var e=c.Persistence.Net.update(a,b);return a.local.res&&b.refresh?e.then(function(d){return a.data=d,c.Persistence.Local.update(a,b).then(function(){return d})}):e},destroy:function(a,b){if(a.local=a.local||{},b=E(b),a.local.req&&b.offline)return c.Persistence.Local.destroy(a,b);var d=c.Persistence.Net.destroy(a,b);return a.local.res&&b.refresh?d.then(function(d){return c.Persistence.Local.destroy(a,b).then(function(){return d},function(a){return c.Error.ENTITY_NOT_FOUND===a.name?d:c.Defer.reject(a)})}):d}};var F={batch:u("Database.batch"),clean:u("Database.clean"),count:u("Database.count"),destroy:u("Database.destroy"),destruct:u("Database.destruct"),find:u("Database.find"),findAndModify:u("Database.findAndModify"),get:u("Database.get"),group:u("Database.group"),save:u("Database.save"),update:u("Database.update"),use:v(["batch","clean","count","destroy","destruct","find","findAndModify","get","group","save","update"])};c.Persistence.Local={create:function(a,b){b=b||{};var c=g===a.namespace?g:a.collection;if("_group"===a.id)return F.group(c,a.data,b);var d=n(a.data)?"batch":"save",e=F[d](c,a.data,b);return e.then(function(a){return b.offline&&!1!==b.track?H.notify(c,a,b).then(function(){return a}):a})},read:function(a,b){b=b||{};var d=g===a.namespace?g:a.collection;if("_count"===a.id)return F.count(d,a.query,b);if("_me"===a.collection){var e=c.getActiveUser();if(null!==e)return F.get(d,e._id,b).then(null,function(a){return a.name===c.Error.ENTITY_NOT_FOUND?e:c.Defer.reject(a)});var f=l(c.Error.NO_ACTIVE_USER);return c.Defer.reject(f)}var h;return h=null==a.id?F.find(d,a.query,b):F.get(d,a.id,b),h.then(function(a){return b.relations?D.get(a,b):a})},update:function(a,b){b=b||{};var c=g===a.namespace?g:a.collection,d=F.update(c,a.data,b);return d.then(function(a){return b.offline&&!1!==b.track?H.notify(c,a,b).then(function(){return a}):a})},destroy:function(a,b){b=b||{};var c,d=g===a.namespace?g:a.collection;return c=null==a.id?F.clean(d,a.query,b):F.destroy(d,a.id,b),c.then(function(a){return b.offline&&!1!==b.track?H.notify(d,a.documents,b).then(function(){return a}):a})}};var G=null;c.Persistence.Net={create:function(a,b){return a.method="POST",c.Persistence.Net._request(a,b)},read:function(a,b){if(a.flags=a.flags||{},b=b||{},null!=a.collection&&(!1!==b.fileTls&&(a.flags.kinveyfile_tls=!0),b.fileTtl&&(a.flags.kinveyfile_ttl=b.fileTtl)),b.relations){b.exclude=b.exclude||[];var d=Object.keys(b.relations).filter(function(a){return-1===b.exclude.indexOf(a)});0!==d.length&&(a.flags.retainReferences=!1,a.flags.resolve=d.join(","))}return a.method="GET",c.Persistence.Net._request(a,b)},update:function(a,b){return a.method="PUT",c.Persistence.Net._request(a,b)},destroy:function(a,b){return a.method="DELETE",c.Persistence.Net._request(a,b)},_request:function(a,b){if(null==a.method)throw new c.Error("request argument must contain: method.");if(null==a.namespace)throw new c.Error("request argument must contain: namespace.");if(null==a.auth)throw new c.Error("request argument must contain: auth.");var d;if(null==c.appKey&&y.None!==a.auth)return d=l(c.Error.MISSING_APP_CREDENTIALS),c.Defer.reject(d);if(null==c.masterSecret&&b.skipBL)return d=l(c.Error.MISSING_MASTER_CREDENTIALS),c.Defer.reject(d);var e=[a.namespace,c.appKey,a.collection,a.id];e=e.filter(function(a){return null!=a}).map(c.Persistence.Net.encode);var f=[c.API_ENDPOINT].concat(e).join("/")+"/",g=a.flags||{};if(a.query){var h=a.query.toJSON();g.query=h.filter,null!==h.limit&&(g.limit=h.limit),0!==h.skip&&(g.skip=h.skip),t(h.sort)||(g.sort=h.sort)}b.nocache&&(g._=Math.random().toString(36).substr(2));var i=[];for(var j in g)if(g.hasOwnProperty(j)){var k=s(g[j])?g[j]:JSON.stringify(g[j]);i.push(c.Persistence.Net.encode(j)+"="+c.Persistence.Net.encode(k))}0<i.length&&(f+="?"+i.join("&")),null===G&&(G=z());var m={Accept:"application/json","X-Kinvey-API-Version":c.API_VERSION,"X-Kinvey-Device-Information":G};null!=a.data&&(m["Content-Type"]="application/json; charset=utf-8"),b.contentType&&(m["X-Kinvey-Content-Type"]=b.contentType),b.skipBL&&(m["X-Kinvey-Skip-Business-Logic"]=!0);var n=a.auth().then(function(a){if(null!==a){var b=a.credentials;null!=a.username&&(b=c.Persistence.Net.base64(a.username+":"+a.password)),m.Authorization=a.scheme+" "+b}});return n.then(function(){var d=c.Persistence.Net.request(a.method,f,a.data,m,b).then(function(a){return JSON.parse(a)},function(a){try{a=JSON.parse(a)}catch(b){}if(null!=a&&null!=a.error)a={name:a.error,description:a.description||"",debug:a.debug||""};else{var d={abort:c.Error.REQUEST_ABORT_ERROR,error:c.Error.REQUEST_ERROR,timeout:c.Error.REQUEST_TIMEOUT_ERROR};a=l(d[a]||d.error,{debug:a})}return c.Defer.reject(a)});return d.then(null,function(a){return c.Error.INVALID_CREDENTIALS===a.name&&(a.debug+=" It is possible the tokens used to execute the request are expired. In that case, please run `Kinvey.User.logout({ force: true })`, and then log back in  using`Kinvey.User.login(username, password)` to solve this issue."),c.Defer.reject(a)})})},base64:u("Kinvey.Persistence.Net.base64"),encode:u("Kinvey.Persistence.Net.encode"),request:u("Kinvey.Persistence.Net.request"),use:v(["base64","encode","request"])};var H={enabled:!1,online:!0,system:"system.sync",count:function(a,b){if(b=b||{},null!=a)return F.get(H.system,a,b).then(function(a){return a.size},function(a){return c.Error.ENTITY_NOT_FOUND===a.name?0:c.Defer.reject(a)});var d=c.Group.sum("size").toJSON();return F.group(H.system,d,b).then(function(a){return a[0]?a[0].result:0})},execute:function(a){var b=(new c.Query).greaterThan("size",0);return F.find(H.system,b,a).then(function(b){var d=b.map(function(b){return H._collection(b._id,b.documents,a)});return c.Defer.all(d)})},notify:function(a,b,c){return F.findAndModify(H.system,a,function(c){return b=n(b)?b:[b],c=c||{_id:a,documents:{},size:0},b.forEach(function(a){c.documents.hasOwnProperty(a._id)||(c.size+=1);var b=null!=a._kmd?a._kmd.lmt:null;c.documents[a._id]=b}),c},c).then(function(){return null})},_collection:function(a,b,e){var f={collection:a,success:[],error:[]},h=Object.keys(b),i={namespace:g===a?g:d,collection:g===a?null:a,query:(new c.Query).contains("_id",h),auth:y.Default},j=[c.Persistence.Local.read(i,e),c.Persistence.Net.read(i,e)];return c.Defer.all(j).then(function(a){var b={local:{},net:{}};return a[0].forEach(function(a){b.local[a._id]=a}),a[1].forEach(function(a){b.net[a._id]=a}),b}).then(function(d){var g=h.map(function(c){return H._document(a,{id:c,timestamp:b[c]},d.local[c]||null,d.net[c]||null,e).then(null,function(a){return f.error.push(a.id),null})});return c.Defer.all(g)}).then(function(b){var d=b.filter(function(a){return null!=a&&null!==a.document}),f=b.filter(function(a){return null!=a&&null===a.document}),g=[H._save(a,d,e),H._destroy(a,f,e)];return c.Defer.all(g)}).then(function(b){return f.success=f.success.concat(b[0].success,b[1].success),f.error=f.error.concat(b[0].error,b[1].error),F.findAndModify(H.system,a,function(a){return f.success.forEach(function(b){a.documents.hasOwnProperty(b)&&(a.size-=1,delete a.documents[b])}),a},e)}).then(function(){return f})},_destroy:function(a,b,e){if(b=b.map(function(a){return a.id}),0===b.length)return c.Defer.resolve({success:[],error:[]});var f={namespace:g===a?g:d,collection:g===a?null:a,query:(new c.Query).contains("_id",b),auth:y.Default},h=[c.Persistence.Local.destroy(f,e),c.Persistence.Net.destroy(f,e)];return c.Defer.all(h).then(function(){return{success:b,error:[]}},function(){return{success:[],error:b}})},_document:function(a,b,d,e,f){return null===e||null!=e._kmd&&b.timestamp===e._kmd.lmt?c.Defer.resolve({id:b.id,document:d}):null!=f.conflict?f.conflict(a,d,e).then(function(a){return{id:b.id,document:a}},function(){return c.Defer.reject({id:b.id,document:[d,e]})}):c.Defer.reject({id:b.id,document:[d,e]})},_save:function(a,b,e){b=b.map(function(a){return a.document});var f={namespace:g===a?g:d,collection:g===a?null:a,auth:y.Default},h=[],i=b.map(function(a){return f.id=a._id,f.data=a,c.Persistence.Net.update(f,e).then(null,function(){return h.push(a._id),null})});return c.Defer.all(i).then(function(a){return f.id=null,f.data=a,c.Persistence.Local.create(f,e)}).then(function(a){return{success:a.map(function(a){return a._id}),error:h}},function(){return{success:[],error:b.map(function(a){return a._id})}})}};c.Sync={count:function(a,b){if(!c.Sync.isOnline()){var d=l(c.Error.SYNC_ERROR,{debug:"Sync is not enabled, or the application resides in offline mode."});return c.Defer.reject(d)}b=b||{};var e=H.count(a,b);return m(e,b)},destruct:function(a){a=a||{};var b=F.destruct(a);return m(b,a)},execute:function(a){if(!c.Sync.isOnline()){var b=l(c.Error.SYNC_ERROR,{debug:"Sync is not enabled, or the application resides in offline mode."});return c.Defer.reject(b)}a=a||{};var d;return null!=a.user?(d=c.User.login(a.user).then(function(){return delete a.user,c.Sync.execute(a)}),d.then(null,a.error),d):(d=H.execute(a),m(d,a))},init:function(a){return a=a||{},H.enabled=null!=a?a.enable:!1,H.online="undefined"!=typeof a.online?a.online:H.online,c.Defer.resolve(null)},isEnabled:function(){return H.enabled},isOnline:function(){return H.online},offline:function(){if(!c.Sync.isEnabled()){var a=l(c.Error.SYNC_ERROR,{debug:"Sync is not enabled."});return c.Defer.reject(a)}return H.online=!1,c.Defer.resolve(null)},online:function(a){if(!c.Sync.isEnabled()){var b=l(c.Error.SYNC_ERROR,{debug:"Sync is not enabled."});return c.Defer.reject(b)}a=a||{};var d=H.online;return H.online=!0,!1!==a.sync&&d!==H.online?c.Sync.execute(a):c.Defer.resolve(null)},clientAlwaysWins:function(a,b){return c.Defer.resolve(b)},serverAlwaysWins:function(a,b,d){return c.Defer.resolve(d)}},"undefined"!=typeof a.promiscuous&&c.Defer.use(a.promiscuous);var I={db:null,dbName:function(){if(null==c.appKey)throw new c.Error("Kinvey.appKey must not be null.");return"Kinvey."+c.appKey},impl:a.indexedDB||a.webkitIndexedDB||a.mozIndexedDB||a.oIndexedDB||a.msIndexedDB,inTransaction:!1,objectID:function(a){a=a||24;for(var b="abcdefghijklmnopqrstuvwxyz0123456789",c="",d=0,e=b.length;a>d;d+=1){var f=Math.floor(Math.random()*e);c+=b.substring(f,f+1)}return c},pending:[],transaction:function(a,b,d,e,f){if(!/^[a-zA-Z0-9\-]{1,128}/.test(a))return e(l(c.Error.INVALID_IDENTIFIER,{description:"The collection name has an invalid format.",debug:"The collection name may only contain alphanumeric characters and dashes."}));if(b=b||!1,null!==I.db){if(I.db.objectStoreNames.contains(a)){var g=b?"readwrite":"readonly",h=I.db.transaction([a],g),i=h.objectStore(a);return d(i)}if(!b)return e(l(c.Error.COLLECTION_NOT_FOUND,{description:"This collection not found for this app backend",debug:{collection:a}}))}if(!0!==f&&I.inTransaction)return I.pending.push(function(){I.transaction(a,b,d,e)});I.inTransaction=!0;var j;if(null!==I.db){var k=I.db.version+1;j=I.impl.open(I.db.name,k)}else{if(null==c.appKey)return I.inTransaction=!1,e(l(c.Error.MISSING_APP_CREDENTIALS));j=I.impl.open(I.dbName())}j.onupgradeneeded=function(){I.db=j.result,b&&I.db.createObjectStore(a,{keyPath:"_id"})},j.onsuccess=function(){I.db=j.result,I.db.onversionchange=function(){I.db.close(),I.db=null};var c=function(a){return function(b){var c=a(b);if(I.inTransaction=!1,0!==I.pending.length){var d=I.pending;I.pending=[],d.forEach(function(a){a()})}return c}};I.transaction(a,b,c(d),c(e),!0)},j.onerror=function(a){e(l(c.Error.DATABASE_ERROR,{debug:a}))}},batch:function(a,b){if(0===b.length)return c.Defer.resolve(b);var d=c.Defer.deferred();return I.transaction(a,!0,function(a){var e=a.transaction;b.forEach(function(b){b._id=b._id||I.objectID(),a.put(b)}),e.oncomplete=function(){d.resolve(b)},e.onerror=function(a){var b=l(c.Error.DATABASE_ERROR,{debug:a});d.reject(b)}},function(a){d.reject(a)}),d.promise},clean:function(a,b,d){return null!=b&&b.sort(null).limit(null).skip(0),I.find(a,b,d).then(function(b){if(0===b.length)return{count:0,documents:[]};var d=c.Defer.deferred();return I.transaction(a,!0,function(a){var e=a.transaction;b.forEach(function(b){a["delete"](b._id)}),e.oncomplete=function(){d.resolve({count:b.length,documents:b})},e.onerror=function(a){var b=l(c.Error.DATABASE_ERROR,{debug:a});d.reject(b)}}),d.promise})},count:function(a,b,c){return null!=b&&b.sort(null).limit(null).skip(0),I.find(a,b,c).then(function(a){return{count:a.length}})},destroy:function(a,b){var d=c.Defer.deferred();return I.transaction(a,!0,function(e){var f=e.transaction,g=e.get(b);e["delete"](b),f.oncomplete=function(){return null==g.result?d.reject(l(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}})):(d.resolve({count:1,documents:[g.result]}),void 0)},f.onerror=function(a){var b=l(c.Error.DATABASE_ERROR,{debug:a});d.reject(b)}},function(a){d.reject(a)}),d.promise},destruct:function(){if(null==c.appKey){var a=l(c.Error.MISSING_APP_CREDENTIALS);return c.Defer.reject(a)}var b=c.Defer.deferred(),d=I.impl.deleteDatabase(I.dbName());return d.onsuccess=function(){I.db=null,b.resolve(null)},d.onerror=function(a){var d=l(c.Error.DATABASE_ERROR,{debug:a});b.reject(d)},b.promise},find:function(b,d){var e=c.Defer.deferred();return I.transaction(b,!1,function(a){var b=a.openCursor(),d=[];b.onsuccess=function(){var a=b.result;null!=a?(d.push(a.value),a["continue"]()):e.resolve(d)},b.onerror=function(a){e.reject(l(c.DATABASE_ERROR,{debug:a}))}},function(a){return c.Error.COLLECTION_NOT_FOUND===a.name?e.resolve([]):e.reject(a)}),e.promise.then(function(b){return null==d?b:(b=a.sift(d.toJSON().filter,b),d._postProcess(b))})},findAndModify:function(a,b,d){var e=c.Defer.deferred();return I.transaction(a,!0,function(a){var f=null,g=a.get(b);g.onsuccess=function(){f=d(g.result||null),a.put(f)};var h=a.transaction;h.oncomplete=function(){e.resolve(f)},h.onerror=function(a){var b=l(c.Error.DATABASE_ERROR,{debug:a});e.reject(b)}},function(a){e.reject(a)}),e.promise},get:function(a,b){var d=c.Defer.deferred();return I.transaction(a,!1,function(e){var f=e.get(b);f.onsuccess=function(){return null!=f.result?d.resolve(f.result):(d.reject(l(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}})),void 0)},f.onerror=function(a){d.reject(l(c.Error.DATABASE_ERROR,{debug:a}))}},function(e){c.Error.COLLECTION_NOT_FOUND===e.name&&(e=l(c.Error.ENTITY_NOT_FOUND,{description:"This entity not found in the collection",debug:{collection:a,id:b}})),d.reject(e)}),d.promise},group:function(a,b,d){var e=b.reduce.replace(/function[\s\S]*?\([\s\S]*?\)/,"");b.reduce=new Function(["doc","out"],e);var f=new c.Query({filter:b.condition});return I.find(a,f,d).then(function(a){var c={};a.forEach(function(a){var d={};for(var e in b.key)b.key.hasOwnProperty(e)&&(d[e]=a[e]);var f=JSON.stringify(d);if(null==c[f]){c[f]=d;for(var g in b.initial)b.initial.hasOwnProperty(g)&&(c[f][g]=b.initial[g])}b.reduce(a,c[f])});var d=[];for(var e in c)c.hasOwnProperty(e)&&d.push(c[e]);return d})},save:function(a,b){b._id=b._id||I.objectID();var d=c.Defer.deferred();return I.transaction(a,!0,function(a){var e=a.put(b);e.onsuccess=function(){d.resolve(b)},e.onerror=function(a){var b=l(c.Error.DATABASE_ERROR,{debug:a});d.reject(b)}},function(a){d.reject(a)}),d.promise},update:function(a,b,c){return I.save(a,b,c)}};"undefined"!=typeof I.impl&&"undefined"!=typeof a.sift&&(F.use(I),["near","regex","within"].forEach(function(b){a.sift.useOperator(b,function(){throw new c.Error(b+" query operator is not supported locally.")})}));var J={facebook:function(a){return J.oAuth2("facebook",a)},google:function(a){return J.oAuth2("google",a)},linkedIn:function(a){return J.oAuth1("linkedIn",a)},twitter:function(a){return J.oAuth1("twitter",a)},oAuth1:function(a,b){return J.requestToken(a,b).then(function(a){if(a.error||a.denied){var b=l(c.Error.SOCIAL_ERROR,{debug:a});return c.Defer.reject(b)}return{oauth_token:a.oauth_token,oauth_token_secret:a.oauth_token_secret,oauth_verifier:a.oauth_verifier}}).then(function(d){return c.Persistence.Net.create({namespace:g,data:d,flags:{provider:a,step:"verifyToken"},auth:y.App},b)}).then(function(c){return b._provider=a,c})},oAuth2:function(a,b){return b.state=Math.random().toString(36).substr(2),J.requestToken(a,b).then(function(a){var d;return a.state!==b.state?(d=l(c.Error.SOCIAL_ERROR,{debug:"The state parameters did not match (CSRF attack?)."}),c.Defer.reject(d)):a.error?(d=l(c.Error.SOCIAL_ERROR,{debug:a}),c.Defer.reject(d)):{access_token:a.access_token,expires_in:a.expires_in}})},requestToken:function(b,d){var e=d.redirect||a.location.toString();return c.Persistence.Net.create({namespace:g,data:{redirect:e,state:d.state},flags:{provider:b,step:"requestToken"},auth:y.App},d).then(function(b){var e=c.Defer.deferred(),f=a.open(b.url,"KinveyOAuth2"),g=0,h=100,i=a.setInterval(function(){var j;if(null==f.location)a.clearTimeout(i),j=l(c.Error.SOCIAL_ERROR,{debug:"The popup was closed unexpectedly."}),e.reject(j);else if(d.timeout&&g>d.timeout)a.clearTimeout(i),f.close(),j=l(c.Error.SOCIAL_ERROR,{debug:"The user waited too long to reply to the authorization request."}),e.reject(j);else if(f.location.host){a.clearTimeout(i),f.close();var k=f.location,m=k.search.substring(1)+"&"+k.hash.substring(1),n=J.tokenize(m);null!=b.oauth_token_secret&&(n.oauth_token_secret=b.oauth_token_secret),e.resolve(n)}g+=h},h);return e.promise})},tokenize:function(b){var c={};return b.split("&").forEach(function(b){var d=b.split("=",2).map(a.decodeURIComponent);d[0]&&(c[d[0]]=d[1])}),c}};if(B.use(J),"undefined"!=typeof localStorage){var K={_destroy:function(a){return localStorage.removeItem(a),c.Defer.resolve(null)},_get:function(a){var b=localStorage.getItem(a);return c.Defer.resolve(b?JSON.parse(b):null)},_save:function(a,b){return localStorage.setItem(a,JSON.stringify(b)),c.Defer.resolve(null)}};w.use(K)}c.Backbone={getActiveUser:function(){var a=c.getActiveUser();return null!==a?new c.Backbone.User(a):null}},c.Error.NOT_LOGGED_IN="NotLoggedIn",j[c.Error.NOT_LOGGED_IN]={name:c.Error.NOT_LOGGED_IN,description:"This user is not logged in.",debug:""};var L={sync:function(){return c.Backbone.Sync.apply(this,arguments)}},M=function(a,b,c){c="undefined"==typeof c?!0:c;var d=b.success;b.success=function(e){if(c)if(a instanceof Backbone.Model){if(!a.set(a.parse(e,b),b))return!1}else{var f=b.reset?"reset":"set";a[f]||(f=o(a.update)?"update":"reset"),a[f](e,b)}d&&d(a,e,b),c&&a.trigger("sync",a,e,b)};var e=b.error;b.error=function(d){e&&e(a,d,b),c&&a.trigger("error",a,d,b)}},N=function(a,b){var d=a.then(function(a){var c=b.xhr?[b.xhr.statusText,b.xhr]:[];return[a].concat(c)},function(a){var d=b.xhr?[b.xhr.statusText,b.xhr]:[null,null];return c.Defer.reject(d.concat([a]))});if("undefined"==typeof jQuery||"undefined"==typeof jQuery.Deferred)return d;var e=jQuery.Deferred();return d.then(function(a){e.resolve.apply(e,a)},function(a){e.reject.apply(e,a)}),e.promise()};c.Backbone.ModelMixin=_.extend({},L,{idAttribute:"_id",relations:[]}),c.Backbone.CollectionMixin=_.extend({},L,{query:null,clean:function(a){return a=a?_.clone(a):{},a.parse="undefined"==typeof a.parse?!0:a.parse,M(this,a),this.sync("delete",this,a)},count:function(a){a=_.clone(a)||{},a.subject=this,M(this,a,!1);var b,d=_.result(this,"url"),e=a.query||this.query;return b=g===d?c.User.count(e,a):c.DataStore.count(d,e,a),N(b,a)},group:function(a,b){b=_.clone(b)||{},b.subject=this,M(this,b,!1);var d=b.query||this.query;null!=d&&a.query(d);var e,f=_.result(this,"url");return e=g===f?c.User.group(a,b):c.DataStore.group(f,a,b),N(e,b)}});var O=function(a){return function(){return null===this._metadata&&(this._metadata=new c.Metadata(this.attributes)),a.apply(this._metadata,arguments)}};_.extend(c.Backbone.ModelMixin,{_metadata:null,getAcl:O(c.Metadata.prototype.getAcl),getCreatedAt:O(c.Metadata.prototype.getCreatedAt),getLastModified:O(c.Metadata.prototype.getLastModified),setAcl:function(){return O(c.Metadata.prototype.setAcl).apply(this,arguments),this}});var P={url:g};c.Backbone.UserMixin=_.extend({},c.Backbone.ModelMixin,P,{connect:function(a,b){b=b?_.clone(b):{},b.parse="undefined"==typeof b.parse?!0:b.parse,b.subject=this,M(this,b);var d=c.Social.connect(this.attributes,a,b);return N(d,b)},disconnect:function(a,b){b=b?_.clone(b):{},b.parse="undefined"==typeof b.parse?!0:b.parse,b.subject=this,M(this,b);var d=c.Social.disconnect(this.attributes,a,b);return N(d,b)},getEmailVerification:O(c.Metadata.prototype.getEmailVerification),isLoggedIn:function(){var a=c.getActiveUser();if(null!==a){var b=this.get("_kmd");return null!=b&&b.authtoken===a._kmd.authtoken}return!1},login:function(a,b,d){d=_.clone(q(a)?b:d)||{},d.parse="undefined"==typeof d.parse?!0:d.parse,d.subject=this,M(this,d);var e=c.User.login(a,b,d);return N(e,d)},logout:function(a){a=a?_.clone(a):{},a.parse="undefined"==typeof a.parse?!0:a.parse,a.subject=this,M(this,a);var b;if(this.isLoggedIn())b=c.User.logout(a);else{var d=l(c.Error.NOT_LOGGED_IN);b=c.Defer.reject(d),m(b,a)}return N(b,a)},me:function(a){a=a?_.clone(a):{},a.parse="undefined"==typeof a.parse?!0:a.parse,a.subject=this,M(this,a);var b;if(this.isLoggedIn())b=c.User.me(a);else{var d=l(c.Error.NOT_LOGGED_IN);b=c.Defer.reject(d),m(b,a)}return N(b,a)}}),c.Backbone.StaticUserMixin={verifyEmail:function(a,b){b=b||{};var d=c.User.verifyEmail(a,b);return N(d,b)},forgotUsername:function(a,b){b=b||{};var d=c.User.forgotUsername(a,b);return N(d,b)},resetPassword:function(a,b){b=b||{};var d=c.User.resetPassword(a,b);return N(d,b)},exists:function(a,b){b=b||{};var d=c.User.exists(a,b);return N(d,b)},restore:function(a,b){b=b||{};var d=c.User.restore(a,b);return N(d,b)}},c.Backbone.UserCollectionMixin=_.extend(_.omit(c.Backbone.CollectionMixin,"clean"),P);var Q=function(b,d){var e=[],f={},g="read"===b?"autoFetch":"autoSave",h=[],i=function(a,b,c){a.forEach(function(a){h.push({relation:a,depth:b||0,prefix:c||null})})};i(d.relations||[]);for(var j;null!=(j=h.shift());){var k=j.depth,l=j.prefix,m=j.relation;if(10!==k){var n=null;m.relatedModel&&(n=(a[m.relatedModel]||m.relatedModel).prototype);var o=m.collection||_.result(n,"url");if(null==o)throw new c.Error("collection or relatedModel must be set on the relation.");0===o.indexOf("/")&&(o=o.substr(1));var p=null!==l?l+"."+m.key:m.key;f[p]=o,!1===m[g]&&e.push(p),!1===m[g]||null==n||t(n.relations)||i(n.relations,k+1,p)}}return{exclude:e,relations:f}},R=function(a,b,d,e,f){null!=d&&q(e)&&(e._id=d);var h=null==d&&(!q(e)||n(e)),i=g===b?c.User:c.DataStore,j={create:i[g===b?"create":"save"],read:h?i.find:i.get,update:i.update,"delete":h?i.clean:i.destroy},k=[h?f.query:"read"===a||"delete"===a?d:e,f];return g!==b&&k.unshift(b),j[a].apply(i,k)};c.Backbone.Sync=function(a,b,d){d.query=d.query||b.query,d.subject=b;var e=d.silent,f=d.success;d.silent=d.silentFail||!1,d.success=function(a){d.silent=e,f&&f(a)};var g=d.attrs||b.toJSON(d),h=d.url||_.result(b,"url");if(null==h)throw new c.Error("model or options argument must contain: url.");0===h.indexOf("/")&&(h=h.substr(1));var i=h.split("/"),j=i[0],k=i[1]||g._id||null,l=b.model?b.model.prototype.relations:b.relations;if(!t(l)){var m="read"===a?"read":"write";l=Q(m,this.model?this.model.prototype:this),d.exclude=l.exclude,d.relations=l.relations}var n=R(a,j,k,g,d);return N(n,d)};var S={base64:function(b){return a.btoa(b)},supportsBlob:function(){try{return new a.Blob&&!0}catch(b){return!1}}(),encode:a.encodeURIComponent,request:function(b,d,e,f,g){e=e||null,f=f||{},g=g||{};var h=c.Defer.deferred();if(0===d.indexOf(c.API_ENDPOINT)&&"GET"===b){var i=a.location;null!=i&&null!=i.protocol&&(f["X-Kinvey-Origin"]=i.protocol+"//"+i.host)}var j=function(b,c){var d=b.status;if(2===parseInt(d/100,10)||304===d){var e=b.responseText;if(g.file&&null!=e){for(var f=new a.ArrayBuffer(e.length),i=new a.Uint8Array(f),j=0,k=e.length;k>j;j+=1)i[j]=e.charCodeAt(j);S.supportsBlob&&(f=new a.Blob([i],{type:g.file})),e=f}h.resolve(e||null)}else h.reject(b.responseText||c||null)};!q(e)||e instanceof a.ArrayBuffer||e instanceof a.Blob||(e=JSON.stringify(e));var k=g.xhr=Backbone.ajax({complete:j,data:e,dataType:"json",headers:f,mimeType:g.file?"text/plain; charset=x-user-defined":null,processData:!1,timeout:g.timeout,type:b,url:d,beforeSend:function(){return g.beforeSend?g.beforeSend.apply(this,arguments):void 0}});if(null!=g.subject){var l=g.subject;delete g.subject,o(l.trigger)&&l.trigger("request",l,k,g)}return h.promise}};"undefined"!=typeof Backbone&&c.Persistence.Net.use(S);var T;return T="undefined"!=typeof Backbone.AssociatedModel?Backbone.AssociatedModel:Backbone.Model,c.Backbone.Model=T.extend(c.Backbone.ModelMixin),c.Backbone.Collection=Backbone.Collection.extend(_.extend({},c.Backbone.CollectionMixin,{model:c.Backbone.Model,initialize:function(a,b){var d=Backbone.Collection.prototype.initialize.apply(this,arguments);if(b=b||{},null!=b.query&&!(b.query instanceof c.Query))throw new c.Error("options.query argument must be of type: Kinvey.Query.");return this.query=b.query,d}})),c.Backbone.User=T.extend(c.Backbone.UserMixin,c.Backbone.StaticUserMixin),c.Backbone.UserCollection=Backbone.Collection.extend(_.extend({},c.Backbone.UserCollectionMixin,{model:c.Backbone.User,initialize:c.Backbone.Collection.prototype.initialize})),c},c=b();"object"==typeof module&&"object"==typeof module.exports?module.exports=c:"function"==typeof define&&define.amd?define("kinvey",[],function(){return c}):a.Kinvey=c}.call(this);